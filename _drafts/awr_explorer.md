



### How To Setup And Use DBMS_CLOUD Package (Doc ID 2748362.1)	


#### Installing DBMS_CLOUD


dbms_cloud_install.sql 

```
@$ORACLE_HOME/rdbms/admin/sqlsessstart.sql

set verify off
-- you must not change the owner of the functionality to avoid future issues
define username='C##CLOUD$SERVICE'

create user &username no authentication account lock;

REM Grant Common User Privileges
grant INHERIT PRIVILEGES on user &username to sys;
grant INHERIT PRIVILEGES on user sys to &username;
grant RESOURCE, UNLIMITED TABLESPACE, SELECT_CATALOG_ROLE to &username;
grant CREATE ANY TABLE, DROP ANY TABLE, INSERT ANY TABLE, SELECT ANY TABLE,
CREATE ANY CREDENTIAL, CREATE PUBLIC SYNONYM, CREATE PROCEDURE, ALTER SESSION, CREATE JOB to &username;
grant CREATE SESSION, SET CONTAINER to &username;
grant SELECT on SYS.V_$MYSTAT to &username;
grant SELECT on SYS.SERVICE$ to &username;
grant SELECT on SYS.V_$ENCRYPTION_WALLET to &username;
grant read, write on directory DATA_PUMP_DIR to &username;
grant EXECUTE on SYS.DBMS_PRIV_CAPTURE to &username;
grant EXECUTE on SYS.DBMS_PDB_LIB to &username;
grant EXECUTE on SYS.DBMS_CRYPTO to &username;
grant EXECUTE on SYS.DBMS_SYS_ERROR to &username;
grant EXECUTE ON SYS.DBMS_ISCHED to &username;
grant EXECUTE ON SYS.DBMS_PDB_LIB to &username;
grant EXECUTE on SYS.DBMS_PDB to &username;
grant EXECUTE on SYS.DBMS_SERVICE to &username;
grant EXECUTE on SYS.DBMS_PDB to &username;
grant EXECUTE on SYS.CONFIGURE_DV to &username;
grant EXECUTE on SYS.DBMS_SYS_ERROR to &username;
grant EXECUTE on SYS.DBMS_CREDENTIAL to &username;
grant EXECUTE on SYS.DBMS_RANDOM to &username;
grant EXECUTE on SYS.DBMS_SYS_SQL to &username;
grant EXECUTE on SYS.DBMS_LOCK to &username;
grant EXECUTE on SYS.DBMS_AQADM to &username;
grant EXECUTE on SYS.DBMS_AQ to &username;
grant EXECUTE on SYS.DBMS_SYSTEM to &username;
grant EXECUTE on SYS.SCHED$_LOG_ON_ERRORS_CLASS to &username;
grant SELECT on SYS.DBA_DATA_FILES to &username;
grant SELECT on SYS.DBA_EXTENTS to &username;
grant SELECT on SYS.DBA_CREDENTIALS to &username;
grant SELECT on SYS.AUDIT_UNIFIED_ENABLED_POLICIES to &username;
grant SELECT on SYS.DBA_ROLES to &username;
grant SELECT on SYS.V_$ENCRYPTION_KEYS to &username;
grant SELECT on SYS.DBA_DIRECTORIES to &username;
grant SELECT on SYS.DBA_USERS to &username;
grant SELECT on SYS.DBA_OBJECTS to &username;
grant SELECT on SYS.V_$PDBS to &username;
grant SELECT on SYS.V_$SESSION to &username;
grant SELECT on SYS.GV_$SESSION to &username;
grant SELECT on SYS.DBA_REGISTRY to &username;
grant SELECT on SYS.DBA_DV_STATUS to &username;

alter session set current_schema=&username;
REM Create the Catalog objects
@$ORACLE_HOME/rdbms/admin/dbms_cloud_task_catalog.sql
@$ORACLE_HOME/rdbms/admin/dbms_cloud_task_views.sql
@$ORACLE_HOME/rdbms/admin/dbms_cloud_catalog.sql
@$ORACLE_HOME/rdbms/admin/dbms_cloud_types.sql

REM Create the Package Spec
@$ORACLE_HOME/rdbms/admin/prvt_cloud_core.plb
@$ORACLE_HOME/rdbms/admin/prvt_cloud_task.plb
@$ORACLE_HOME/rdbms/admin/dbms_cloud_capability.sql
@$ORACLE_HOME/rdbms/admin/prvt_cloud_request.plb
@$ORACLE_HOME/rdbms/admin/prvt_cloud_internal.plb
@$ORACLE_HOME/rdbms/admin/dbms_cloud.sql
@$ORACLE_HOME/rdbms/admin/prvt_cloud_admin_int.plb

REM Create the Package Body
@$ORACLE_HOME/rdbms/admin/prvt_cloud_core_body.plb
@$ORACLE_HOME/rdbms/admin/prvt_cloud_task_body.plb
@$ORACLE_HOME/rdbms/admin/prvt_cloud_capability_body.plb
@$ORACLE_HOME/rdbms/admin/prvt_cloud_request_body.plb
@$ORACLE_HOME/rdbms/admin/prvt_cloud_internal_body.plb
@$ORACLE_HOME/rdbms/admin/prvt_cloud_body.plb
@$ORACLE_HOME/rdbms/admin/prvt_cloud_admin_int_body.plb

-- Create the metadata
@$ORACLE_HOME/rdbms/admin/dbms_cloud_metadata.sql

alter session set current_schema=sys;

@$ORACLE_HOME/rdbms/admin/sqlsessend.sql
```



[oracle@awrdb admin]$ cat tnsnames.ora 
# tnsnames.ora Network Configuration File: /u01/app/oracle/product/19.0.0.0/dbhome_1/network/admin/tnsnames.ora
# Generated by Oracle configuration tools.

AWRDB_IAD1WF =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = awrdb)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = awrdb_iad1wf.sub01040135480.ashvcn.oraclevcn.com)
    )
  )

LISTENER_AWRDB =
  (ADDRESS = (PROTOCOL = TCP)(HOST = awrdb)(PORT = 1521))


[oracle@awrdb admin]$ sqlplus sys/WElcome#1234-@AWRDB_IAD1WF as sysdba

SQL*Plus: Release 19.0.0.0.0 - Production on Wed Feb 15 20:24:34 2023
Version 19.17.0.0.0

Copyright (c) 1982, 2022, Oracle.  All rights reserved.


Connected to:
Oracle Database 19c EE High Perf Release 19.0.0.0.0 - Production
Version 19.17.0.0.0

SQL> exit
Disconnected from Oracle Database 19c EE High Perf Release 19.0.0.0.0 - Production
Version 19.17.0.0.0
[oracle@awrdb admin]$ 





$ORACLE_HOME/perl/bin/perl $ORACLE_HOME/rdbms/admin/catcon.pl -u sys/WElcome#1234- --force_pdb_mode 'READ WRITE' -b dbms_cloud_install -d /home/oracle/dbc -l /home/oracle/dbc dbms_cloud_install.sql





```
[oracle@awrdb dbc]$ $ORACLE_HOME/perl/bin/perl $ORACLE_HOME/rdbms/admin/catcon.pl -u sys/WElcome#1234- --force_pdb_mode 'READ WRITE' -b dbms_cloud_install -d /home/oracle/dbc -l /home/oracle/dbc dbms_cloud_install.sql
catcon::set_log_file_base_path: ALL catcon-related output will be written to [/home/oracle/dbc/dbms_cloud_install_catcon_54820.lst]

catcon::set_log_file_base_path: catcon: See [/home/oracle/dbc/dbms_cloud_install*.log] files for output generated by scripts

catcon::set_log_file_base_path: catcon: See [/home/oracle/dbc/dbms_cloud_install_*.lst] files for spool files, if any


catcon.pl: completed successfully
[oracle@awrdb dbc]$ 
```

REM from within ROOT to see all containers
select con_id, owner, object_name, status, sharing, oracle_maintained from cdb_objects where object_name = 'DBMS_CLOUD' order by con_id;

REM within an individual container only
select owner, object_name, status, sharing, oracle_maintained from dba_objects where object_name = 'DBMS_CLOUD';


```
SQL> @colfmt
COL "CON_ID"                         FOR 999999
COL "OWNER"                          FOR A16
COL "OBJECT_NAME"                    FOR A11
COL "STATUS"                         FOR A6
COL "SHARING"                        FOR A13
COL "ORACLE_MAINTAINED"              FOR A17
SQL> select con_id, owner, object_name, status, sharing, oracle_maintained from cdb_objects where object_name = 'DBMS_CLOUD' order by con_id;

 CON_ID OWNER		 OBJECT_NAME STATUS SHARING	  ORACLE_MAINTAINED
------- ---------------- ----------- ------ ------------- -----------------
      1 PUBLIC		 DBMS_CLOUD  VALID  METADATA LINK Y
      1 C##CLOUD$SERVICE DBMS_CLOUD  VALID  METADATA LINK Y
      1 C##CLOUD$SERVICE DBMS_CLOUD  VALID  METADATA LINK Y
      3 PUBLIC		 DBMS_CLOUD  VALID  METADATA LINK Y
      3 C##CLOUD$SERVICE DBMS_CLOUD  VALID  METADATA LINK Y
      3 C##CLOUD$SERVICE DBMS_CLOUD  VALID  METADATA LINK Y

6 rows selected.

SQL> show pdbs

    CON_ID CON_NAME			  OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
	 2 PDB$SEED			  READ ONLY  NO
	 3 PDB1 			  READ WRITE NO
SQL> alter session set container=pdb1;

Session altered.

SQL> select owner, object_name, status, sharing, oracle_maintained from dba_objects where object_name = 'DBMS_CLOUD';

OWNER		 OBJECT_NAME STATUS SHARING	  ORACLE_MAINTAINED
---------------- ----------- ------ ------------- -----------------
PUBLIC		 DBMS_CLOUD  VALID  METADATA LINK Y
C##CLOUD$SERVICE DBMS_CLOUD  VALID  METADATA LINK Y
C##CLOUD$SERVICE DBMS_CLOUD  VALID  METADATA LINK Y

SQL> 
```

#### Create SSL Wallet with Certificates


$ wget https://objectstorage.us-phoenix-1.oraclecloud.com/p/QsLX1mx9A-vnjjohcC7TIK6aTDFXVKr0Uogc2DAN-Rd7j6AagsmMaQ3D3Ti4a9yU/n/adwcdemo/b/CERTS/o/dbc_certs.tar

https://sales-emea-japac.slack.com/archives/CUAARMAHK/p1673160307381569 

[oracle@awrdb tde]$ pwd
/opt/oracle/dcs/commonstore/wallets/awrdb_iad1wf/tde
[oracle@awrdb tde]$ ls -tlr
total 32
-rw------- 1 oracle asmadmin 2555 Feb 15 19:53 ewallet_2023021511530245.p12
-rw------- 1 oracle oinstall    0 Feb 15 19:56 ewallet.p12.lck
-rw------- 1 oracle oinstall    0 Feb 15 19:56 cwallet.sso.lck
-rw------- 1 oracle asmadmin 3995 Feb 15 19:56 ewallet_2023021511564138.p12
-rw------- 1 oracle asmadmin 5467 Feb 15 19:56 ewallet.p12
-rw------- 1 oracle asmadmin 5512 Feb 15 19:56 cwallet.sso
[oracle@awrdb tde]$ 


[oracle@awrdb dbc]$ pwd
/home/oracle/dbc
[oracle@awrdb dbc]$ ls /home/oracle/dbc/*cer
/home/oracle/dbc/Actalis.cer              /home/oracle/dbc/Certum2.cer    /home/oracle/dbc/GeoTrust2.cer      /home/oracle/dbc/QuoVadis3.cer     /home/oracle/dbc/Thawte1.cer
/home/oracle/dbc/AddTrust1.cer            /home/oracle/dbc/Chunghwa.cer   /home/oracle/dbc/GeoTrust3.cer      /home/oracle/dbc/QuoVadis4.cer     /home/oracle/dbc/Thawte2.cer
/home/oracle/dbc/AddTrust2.cer            /home/oracle/dbc/Comodo1.cer    /home/oracle/dbc/GeoTrust4.cer      /home/oracle/dbc/QuoVadis5.cer     /home/oracle/dbc/Thawte3.cer
/home/oracle/dbc/AddTrust3.cer            /home/oracle/dbc/Comodo2.cer    /home/oracle/dbc/GeoTrust5.cer      /home/oracle/dbc/QuoVadis6.cer     /home/oracle/dbc/Thawte4.cer
/home/oracle/dbc/AffirmTrust1.cer         /home/oracle/dbc/Comodo3.cer    /home/oracle/dbc/GlobalSign1.cer    /home/oracle/dbc/SecomTrust1.cer   /home/oracle/dbc/Thawte5.cer
/home/oracle/dbc/AffirmTrust2.cer         /home/oracle/dbc/DigiCert1.cer  /home/oracle/dbc/GlobalSign2.cer    /home/oracle/dbc/SecomTrust2.cer   /home/oracle/dbc/UserTrust1.cer
/home/oracle/dbc/AffirmTrust3.cer         /home/oracle/dbc/DigiCert2.cer  /home/oracle/dbc/GlobalSign3.cer    /home/oracle/dbc/SecureTrust.cer   /home/oracle/dbc/UserTrust2.cer
/home/oracle/dbc/AffirmTrust4.cer         /home/oracle/dbc/DigiCert3.cer  /home/oracle/dbc/GlobalSign4.cer    /home/oracle/dbc/SSLCom1.cer       /home/oracle/dbc/UserTrust3.cer
/home/oracle/dbc/Amazon1.cer              /home/oracle/dbc/DigiCert4.cer  /home/oracle/dbc/GlobalSign5.cer    /home/oracle/dbc/SSLCom2.cer       /home/oracle/dbc/UserTrust4.cer
/home/oracle/dbc/Amazon2.cer              /home/oracle/dbc/DigiCert5.cer  /home/oracle/dbc/GoDaddy1.cer       /home/oracle/dbc/Starfield1.cer    /home/oracle/dbc/UserTrust5.cer
/home/oracle/dbc/Amazon3.cer              /home/oracle/dbc/DigiCert6.cer  /home/oracle/dbc/GoDaddy2.cer       /home/oracle/dbc/Starfield2.cer    /home/oracle/dbc/VeriSign1.cer
/home/oracle/dbc/Amazon4.cer              /home/oracle/dbc/DigiCert7.cer  /home/oracle/dbc/GTECyberTrust.cer  /home/oracle/dbc/Starfield3.cer    /home/oracle/dbc/VeriSign2.cer
/home/oracle/dbc/BaltimoreCyberTrust.cer  /home/oracle/dbc/DigiCert8.cer  /home/oracle/dbc/IdenTrust1.cer     /home/oracle/dbc/Swisscom.cer      /home/oracle/dbc/VeriSign3.cer
/home/oracle/dbc/Buypass1.cer             /home/oracle/dbc/DSTRoot.cer    /home/oracle/dbc/IdenTrust2.cer     /home/oracle/dbc/SwissSign1.cer    /home/oracle/dbc/VeriSign4.cer
/home/oracle/dbc/Buypass2.cer             /home/oracle/dbc/DTrust1.cer    /home/oracle/dbc/ISRG.cer           /home/oracle/dbc/SwissSign2.cer    /home/oracle/dbc/VeriSign5.cer
/home/oracle/dbc/Camerfirma1.cer          /home/oracle/dbc/DTrust2.cer    /home/oracle/dbc/Keynectis.cer      /home/oracle/dbc/SwissSign3.cer    /home/oracle/dbc/VeriSign6.cer
/home/oracle/dbc/Camerfirma2.cer          /home/oracle/dbc/Entrust1.cer   /home/oracle/dbc/LuxTrust.cer       /home/oracle/dbc/TeleSec1.cer      /home/oracle/dbc/VeriSign7.cer
/home/oracle/dbc/Camerfirma3.cer          /home/oracle/dbc/Entrust2.cer   /home/oracle/dbc/NetLock1.cer       /home/oracle/dbc/TeleSec2.cer      /home/oracle/dbc/XRamp.cer
/home/oracle/dbc/Certplus1.cer            /home/oracle/dbc/Entrust3.cer   /home/oracle/dbc/NetLock2.cer       /home/oracle/dbc/TeleSec3.cer
/home/oracle/dbc/Certplus2.cer            /home/oracle/dbc/Entrust4.cer   /home/oracle/dbc/QuoVadis1.cer      /home/oracle/dbc/TeliaSonera1.cer
/home/oracle/dbc/Certum1.cer              /home/oracle/dbc/GeoTrust1.cer  /home/oracle/dbc/QuoVadis2.cer      /home/oracle/dbc/TeliaSonera2.cer
[oracle@awrdb dbc]$ 

mkdir /opt/oracle/dcs/commonstore/wallets/ssl

cd /opt/oracle/dcs/commonstore/wallets/ssl
orapki wallet create -wallet . -pwd WalletPasswd123 -auto_login
#! /bin/bash
for i in `ls /home/oracle/dbc/*cer`
do
orapki wallet add -wallet . -trusted_cert -cert $i -pwd WalletPasswd123
done

........................
Operation is successfully completed.
Oracle PKI Tool Release 19.0.0.0.0 - Production
Version 19.4.0.0.0
Copyright (c) 2004, 2022, Oracle and/or its affiliates. All rights reserved.
........................





cd /opt/oracle/dcs/commonstore/wallets/ssl
orapki wallet display -wallet .



[oracle@awrdb ssl]$ cd /opt/oracle/dcs/commonstore/wallets/ssl
[oracle@awrdb ssl]$ orapki wallet display -wallet .
Oracle PKI Tool Release 19.0.0.0.0 - Production
Version 19.4.0.0.0
Copyright (c) 2004, 2022, Oracle and/or its affiliates. All rights reserved.

Requested Certificates: 
User Certificates:
Trusted Certificates: 
Subject:        CN=Thawte Timestamping CA,OU=Thawte Certification,O=Thawte,L=Durbanville,ST=Western Cape,C=ZA
Subject:        CN=Go Daddy Root Certificate Authority - G2,O=GoDaddy.com\, Inc.,L=Scottsdale,ST=Arizona,C=US
Subject:        CN=Certum CA,O=Unizeto Sp. z o.o.,C=PL



#### Configure your Oracle environment to use the new SSL wallet

For cloud installations without Grid infrastructure, the default location of this file is $ORACLE_HOME/network/admin.
For cloud installations with Grid infrastructure, the default location of this file is $GRID_HOME/network/admin.

lsnrctl status

Listener Parameter File   /u01/app/19.0.0.0/grid/network/admin/listener.ora
Listener Log File         /u01/app/grid/diag/tnslsnr/awrdb/listener/alert/log.xml

DBHOME
```
[oracle@awrdb admin]$ pwd
/u01/app/oracle/product/19.0.0.0/dbhome_1/network/admin
[oracle@awrdb admin]$ cat sqlnet.ora 
# ENCRYPTION_WALLET_LOCATION=(SOURCE=(METHOD=FILE)(METHOD_DATA=(DIRECTORY=/opt/oracle/dcs/commonstore/wallets/tde/$ORACLE_UNQNAME)))

ENCRYPTION_WALLET_LOCATION=(SOURCE=(METHOD=FILE)(METHOD_DATA=(DIRECTORY=/opt/oracle/dcs/commonstore/wallets/$ORACLE_UNQNAME/tde)))

SQLNET.ENCRYPTION_SERVER=REQUIRED
SQLNET.CRYPTO_CHECKSUM_SERVER=REQUIRED
SQLNET.ENCRYPTION_TYPES_SERVER=(AES256,AES192,AES128)
SQLNET.CRYPTO_CHECKSUM_TYPES_SERVER=(SHA1)
SQLNET.ENCRYPTION_CLIENT=REQUIRED
SQLNET.CRYPTO_CHECKSUM_CLIENT=REQUIRED
SQLNET.ENCRYPTION_TYPES_CLIENT=(AES256,AES192,AES128)
SQLNET.CRYPTO_CHECKSUM_TYPES_CLIENT=(SHA1)
SQLNET.EXPIRE_TIME=10
[oracle@awrdb admin]$ 
```
GRID HOME:
```
[oracle@awrdb admin]$ pwd
/u01/app/19.0.0.0/grid/network/admin
[oracle@awrdb admin]$ cat sqlnet.ora 
# sqlnet.ora Network Configuration File: /u01/app/19.0.0.0/grid/network/admin/sqlnet.ora
# Generated by Oracle configuration tools.

NAMES.DIRECTORY_PATH= (TNSNAMES, EZCONNECT)

SQLNET.EXPIRE_TIME=10
[oracle@awrdb admin]$ 
```
Root user add:
```
WALLET_LOCATION=
(SOURCE=(METHOD=FILE)(METHOD_DATA=
(DIRECTORY=/opt/oracle/dcs/commonstore/wallets/ssl)))
```

```
[oracle@awrdb admin]$ cp sqlnet.ora /tmp/sqlnet.ora_20230215_2109
[oracle@awrdb admin]$ exit
logout
[root@awrdb ~]# su - gird
su: user gird does not exist
[root@awrdb ~]# vi /u01/app/19.0.0.0/grid/network/admin/sqlnet.ora
[root@awrdb ~]# cat /u01/app/19.0.0.0/grid/network/admin/sqlnet.ora
# sqlnet.ora Network Configuration File: /u01/app/19.0.0.0/grid/network/admin/sqlnet.ora
# Generated by Oracle configuration tools.

NAMES.DIRECTORY_PATH= (TNSNAMES, EZCONNECT)

SQLNET.EXPIRE_TIME=10

WALLET_LOCATION=
(SOURCE=(METHOD=FILE)(METHOD_DATA=
(DIRECTORY=/opt/oracle/dcs/commonstore/wallets/ssl)))
[root@awrdb ~]# 
```




#### Configure the Database with ACEs for DBMS_CLOUD

dbc_aces.sql


```
@$ORACLE_HOME/rdbms/admin/sqlsessstart.sql

-- you must not change the owner of the functionality to avoid future issues
define clouduser=C##CLOUD$SERVICE

-- CUSTOMER SPECIFIC SETUP, NEEDS TO BE PROVIDED BY THE CUSTOMER
-- - SSL Wallet directory
--- /opt/oracle/dcs/commonstore/wallets/ssl
--- define sslwalletdir=<Set SSL Wallet Directory>
define sslwalletdir=/opt/oracle/dcs/commonstore/wallets/ssl

--
-- UNCOMMENT AND SET THE PROXY SETTINGS VARIABLES IF YOUR ENVIRONMENT NEEDS PROXYS
--
-- define proxy_uri=<your proxy URI address>
-- define proxy_host=<your proxy DNS name>
-- define proxy_low_port=<your_proxy_low_port>
-- define proxy_high_port=<your_proxy_high_port>

-- Create New ACL / ACE s
begin
-- Allow all hosts for HTTP/HTTP_PROXY
dbms_network_acl_admin.append_host_ace(
host =>'*',
lower_port => 443,
upper_port => 443,
ace => xs$ace_type(
privilege_list => xs$name_list('http', 'http_proxy'),
principal_name => upper('&clouduser'),
principal_type => xs_acl.ptype_db));
--
-- UNCOMMENT THE PROXY SETTINGS SECTION IF YOUR ENVIRONMENT NEEDS PROXYS
--
-- Allow Proxy for HTTP/HTTP_PROXY
-- dbms_network_acl_admin.append_host_ace(
-- host =>'&proxy_host',
-- lower_port => &proxy_low_port,
-- upper_port => &proxy_high_port,
-- ace => xs$ace_type(
-- privilege_list => xs$name_list('http', 'http_proxy'),
-- principal_name => upper('&clouduser'),
-- principal_type => xs_acl.ptype_db));
--
-- END PROXY SECTION
--

-- Allow wallet access
dbms_network_acl_admin.append_wallet_ace(
wallet_path => 'file:&sslwalletdir',
ace => xs$ace_type(privilege_list =>
xs$name_list('use_client_certificates', 'use_passwords'),
principal_name => upper('&clouduser'),
principal_type => xs_acl.ptype_db));
end;
/

-- Setting SSL_WALLET database property
begin
-- comment out the IF block when installed in non-CDB environments
if sys_context('userenv', 'con_name') = 'CDB$ROOT' then
execute immediate 'alter database property set ssl_wallet=''&sslwalletdir''';
--
-- UNCOMMENT THE FOLLOWING COMMAND IF YOU ARE USING A PROXY
--
-- execute immediate 'alter database property set http_proxy=''&proxy_uri''';
end if;
end;
/

@$ORACLE_HOME/rdbms/admin/sqlsessend.sql
```

```
# Connect to CDB$ROOT
connect sys/<password> as sysdba
@@dbc_aces.sql
```

```
[oracle@awrdb dbc]$ vi dbc_ace.sql
[oracle@awrdb dbc]$ sqlplus / as sysdba

SQL*Plus: Release 19.0.0.0.0 - Production on Wed Feb 15 21:15:36 2023
Version 19.17.0.0.0

Copyright (c) 1982, 2022, Oracle.  All rights reserved.


Connected to:
Oracle Database 19c EE High Perf Release 19.0.0.0.0 - Production
Version 19.17.0.0.0
SQL> @@dbc_ace.sql

Session altered.

old   9: principal_name => upper('&clouduser'),
new   9: principal_name => upper('C##CLOUD$SERVICE'),
Enter value for proxy_host: 
old  16: -- host =>'&proxy_host',
new  16: -- host =>'',
Enter value for proxy_low_port: 
old  17: -- lower_port => &proxy_low_port,
new  17: -- lower_port => ,
Enter value for proxy_high_port: 
old  18: -- upper_port => &proxy_high_port,
new  18: -- upper_port => ,
old  21: -- principal_name => upper('&clouduser'),
new  21: -- principal_name => upper('C##CLOUD$SERVICE'),
old  29: wallet_path => 'file:&sslwalletdir',
new  29: wallet_path => 'file:<Set',
old  32: principal_name => upper('&clouduser'),
new  32: principal_name => upper('C##CLOUD$SERVICE'),

PL/SQL procedure successfully completed.

old   4: execute immediate 'alter database property set ssl_wallet=''&sslwalletdir''';
new   4: execute immediate 'alter database property set ssl_wallet=''<Set''';
Enter value for proxy_uri: 
old   8: -- execute immediate 'alter database property set http_proxy=''&proxy_uri''';
new   8: -- execute immediate 'alter database property set http_proxy=''''';

PL/SQL procedure successfully completed.


Session altered.

SQL> 

SQL> select * from database_properties where property_name in ('SSL_WALLET','HTTP_PROXY');

PROPERTY_NAME
--------------------------------------------------------------------------------
PROPERTY_VALUE
--------------------------------------------------------------------------------
DESCRIPTION
--------------------------------------------------------------------------------
SSL_WALLET
<Set
Location of SSL Wallet


SQL> 
```

Success:
```
SQL> @@dbc_ace.sql

Session altered.

old   9: principal_name => upper('&clouduser'),
new   9: principal_name => upper('C##CLOUD$SERVICE'),
Enter value for proxy_host: 
old  16: -- host =>'&proxy_host',
new  16: -- host =>'',
Enter value for proxy_low_port: 
old  17: -- lower_port => &proxy_low_port,
new  17: -- lower_port => ,
Enter value for proxy_high_port: 
old  18: -- upper_port => &proxy_high_port,
new  18: -- upper_port => ,
old  21: -- principal_name => upper('&clouduser'),
new  21: -- principal_name => upper('C##CLOUD$SERVICE'),
old  29: wallet_path => 'file:&sslwalletdir',
new  29: wallet_path => 'file:/opt/oracle/dcs/commonstore/wallets/ssl',
old  32: principal_name => upper('&clouduser'),
new  32: principal_name => upper('C##CLOUD$SERVICE'),

PL/SQL procedure successfully completed.

old   4: execute immediate 'alter database property set ssl_wallet=''&sslwalletdir''';
new   4: execute immediate 'alter database property set ssl_wallet=''/opt/oracle/dcs/commonstore/wallets/ssl''';
Enter value for proxy_uri: 
old   8: -- execute immediate 'alter database property set http_proxy=''&proxy_uri''';
new   8: -- execute immediate 'alter database property set http_proxy=''''';

PL/SQL procedure successfully completed.


Session altered.

SQL> select * from database_properties where property_name in ('SSL_WALLET','HTTP_PROXY');

PROPERTY_NAME
--------------------------------------------------------------------------------
PROPERTY_VALUE
--------------------------------------------------------------------------------
DESCRIPTION
--------------------------------------------------------------------------------
SSL_WALLET
/opt/oracle/dcs/commonstore/wallets/ssl
Location of SSL Wallet


SQL> 
```
You should not see any entry for HTTP_PROXY if your environment does not need one.
Property SSL_WALLET should show the directory where your wallet is located.


#### Verify Configuration of DBMS_CLOUD



-- - SSL Wallet directory and password
define sslwalletdir=<Set SSL Wallet Directory>
define sslwalletpwd=<Set SSL Wallet password>


```
-- you must not change the owner of the functionality to avoid future issues
define clouduser=C##CLOUD$SERVICE

-- CUSTOMER SPECIFIC SETUP, NEEDS TO BE PROVIDED BY THE CUSTOMER
-- - SSL Wallet directory and password
define sslwalletdir=/opt/oracle/dcs/commonstore/wallets/ssl
define sslwalletpwd=WalletPasswd123

-- create and run this procedure as owner of the ACLs, which is the future owner
-- of DBMS_CLOUD
CREATE OR REPLACE PROCEDURE &clouduser..GET_PAGE(url IN VARCHAR2) AS
request_context UTL_HTTP.REQUEST_CONTEXT_KEY;
req UTL_HTTP.REQ;
resp UTL_HTTP.RESP;
data VARCHAR2(32767) default null;
err_num NUMBER default 0;
err_msg VARCHAR2(4000) default null;

BEGIN

-- Create a request context with its wallet and cookie table
request_context := UTL_HTTP.CREATE_REQUEST_CONTEXT(
wallet_path => 'file:&sslwalletdir',
wallet_password => '&sslwalletpwd');

-- Make a HTTP request using the private wallet and cookie
-- table in the request context
req := UTL_HTTP.BEGIN_REQUEST(
url => url,
request_context => request_context);

resp := UTL_HTTP.GET_RESPONSE(req);

DBMS_OUTPUT.PUT_LINE('valid response');

EXCEPTION
WHEN OTHERS THEN
err_num := SQLCODE;
err_msg := SUBSTR(SQLERRM, 1, 3800);
DBMS_OUTPUT.PUT_LINE('possibly raised PLSQL/SQL error: ' ||err_num||' - '||err_msg);

UTL_HTTP.END_RESPONSE(resp);
data := UTL_HTTP.GET_DETAILED_SQLERRM ;
IF data IS NOT NULL THEN
DBMS_OUTPUT.PUT_LINE('possibly raised HTML error: ' ||data);
END IF;
END;
/
set serveroutput on
BEGIN
&clouduser..GET_PAGE('https://objectstorage.eu-frankfurt-1.oraclecloud.com');
END;
/

set serveroutput off
drop procedure &clouduser..GET_PAGE;

```



```
[oracle@awrdb dbc]$ vi verify.sql
[oracle@awrdb dbc]$ sqlplus / as sysdba

SQL*Plus: Release 19.0.0.0.0 - Production on Wed Feb 15 21:26:57 2023
Version 19.17.0.0.0

Copyright (c) 1982, 2022, Oracle.  All rights reserved.


Connected to:
Oracle Database 19c EE High Perf Release 19.0.0.0.0 - Production
Version 19.17.0.0.0

SQL> @verify.sql
old   1: CREATE OR REPLACE PROCEDURE &clouduser..GET_PAGE(url IN VARCHAR2) AS
new   1: CREATE OR REPLACE PROCEDURE C##CLOUD$SERVICE.GET_PAGE(url IN VARCHAR2) AS
old  13: wallet_path => 'file:&sslwalletdir',
new  13: wallet_path => 'file:/opt/oracle/dcs/commonstore/wallets/ssl',
old  14: wallet_password => '&sslwalletpwd');
new  14: wallet_password => 'WalletPasswd123');

Procedure created.

old   2: &clouduser..GET_PAGE('https://objectstorage.eu-frankfurt-1.oraclecloud.com');
new   2: C##CLOUD$SERVICE.GET_PAGE('https://objectstorage.eu-frankfurt-1.oraclecloud.com');
valid response

PL/SQL procedure successfully completed.

old   1: drop procedure &clouduser..GET_PAGE
new   1: drop procedure C##CLOUD$SERVICE.GET_PAGE

Procedure dropped.
```


If you have properly configured the SSL wallet and set up your database environment, the script will return "valid response" when you can successfully reach out to Oracle Object Store.


#### Grant the minimal privileges to a user or role for using DBMS_CLOUD


scott.sql


```
SQL>  create user c##hong identified by Welcome1#Welcome1# container=all;

User created.

SQL> grant connect,resource,dba to c##hong;

Grant succeeded.

SQL> 
```

```
[oracle@awrdb dbc]$ cat hong.sql
set verify off

-- target sample user
define username='c##hong'

REM the following are minimal privileges to use DBMS_CLOUD
REM - this script assumes core privileges
REM - CREATE SESSION
REM - Tablespace quote on the default tablespace for a user

REM for creation of external tables, e.g. DBMS_CLOUD.CREATE_EXTERNAL_TABLE()
grant CREATE TABLE to &username;

REM for using COPY_DATA()
REM - Any log and bad file information is written into this directory
grant read, write on directory DATA_PUMP_DIR to &username;

REM
grant EXECUTE on dbms_cloud to &username;
[oracle@awrdb dbc]$ sqlplus / as sysdba @hong.sql

SQL*Plus: Release 19.0.0.0.0 - Production on Wed Feb 15 21:35:01 2023
Version 19.17.0.0.0

Copyright (c) 1982, 2022, Oracle.  All rights reserved.


Connected to:
Oracle Database 19c EE High Perf Release 19.0.0.0.0 - Production
Version 19.17.0.0.0


Grant succeeded.


Grant succeeded.


Grant succeeded.

SQL> exit
Disconnected from Oracle Database 19c EE High Perf Release 19.0.0.0.0 - Production
Version 19.17.0.0.0
[oracle@awrdb dbc]$ 
```

#### Configure ACEs for a user or role to use DBMS_CLOUD

define sslwalletdir=/opt/oracle/dcs/commonstore/wallets/ssl
define sslwalletpwd=WalletPasswd123

hong_ace.sql

```
@$ORACLE_HOME/rdbms/admin/sqlsessstart.sql

-- target sample role
define cloudrole=CLOUD_USER

-- CUSTOMER SPECIFIC SETUP, NEEDS TO BE PROVIDED BY THE CUSTOMER
-- - SSL Wallet directory
define sslwalletdir=/opt/oracle/dcs/commonstore/wallets/ssl

--
-- UNCOMMENT AND SET THE PROXY SETTINGS VARIABLES IF YOUR ENVIRONMENT NEEDS PROXYS
--
-- define proxy_uri=<your proxy URI address>
-- define proxy_host=<your proxy DNS name>
-- define proxy_low_port=<your_proxy_low_port>
-- define proxy_high_port=<your_proxy_high_port>

-- Create New ACL / ACE s
begin
-- Allow all hosts for HTTP/HTTP_PROXY
dbms_network_acl_admin.append_host_ace(
host =>'*',
lower_port => 443,
upper_port => 443,
ace => xs$ace_type(
privilege_list => xs$name_list('http', 'http_proxy'),
principal_name => upper('&cloudrole'),
principal_type => xs_acl.ptype_db));

--
-- UNCOMMENT THE PROXY SETTINGS SECTION IF YOUR ENVIRONMENT NEEDS PROXYS
--
-- Allow Proxy for HTTP/HTTP_PROXY
-- dbms_network_acl_admin.append_host_ace(
-- host =>'&proxy_host',
-- lower_port => &proxy_low_port,
-- upper_port => &proxy_high_port,
-- ace => xs$ace_type(
-- privilege_list => xs$name_list('http', 'http_proxy'),
-- principal_name => upper('&cloudrole'),
-- principal_type => xs_acl.ptype_db));
--
-- END PROXY SECTION
--

-- Allow wallet access
dbms_network_acl_admin.append_wallet_ace(
wallet_path => 'file:&sslwalletdir',
ace => xs$ace_type(privilege_list =>
xs$name_list('use_client_certificates', 'use_passwords'),
principal_name => upper('&cloudrole'),
principal_type => xs_acl.ptype_db));
end;
/

@$ORACLE_HOME/rdbms/admin/sqlsessend.sql
```






### common_user_prefix pfile


```
SQL> alter system set common_user_prefix='' scope=spfile;

System altered.

SQL> create pfile='/home/oracle/pfile_init.ora' from spfile;

File created.

SQL> shu immediate;
Database closed.
Database dismounted.
ORACLE instance shut down.
SQL> startup 
ORACLE instance started.

Total System Global Area 3.2749E+10 bytes
Fixed Size		   13873784 bytes
Variable Size		 3959422976 bytes
Database Buffers	 2.8588E+10 bytes
Redo Buffers		  187449344 bytes
Database mounted.
Database opened.
SQL> create role test1;   

Role created.

SQL> 

```

```
SQL> create pfile='/home/oracle/pfile_init.ora' from spfile;

File created.

SQL> !cat /home/oracle/pfile_init.ora
awrdb.__data_transfer_cache_size=0
awrdb.__db_cache_size=28454158336
awrdb.__inmemory_ext_roarea=0
awrdb.__inmemory_ext_rwarea=0
awrdb.__java_pool_size=134217728
awrdb.__large_pool_size=201326592
awrdb.__oracle_base='/u01/app/oracle'#ORACLE_BASE set from environment
awrdb.__pga_aggregate_target=8187281408
awrdb.__sga_target=32749125632
awrdb.__shared_io_pool_size=134217728
awrdb.__shared_pool_size=3623878656
awrdb.__streams_pool_size=0
awrdb.__unified_pga_pool_size=0
*._datafile_write_errors_crash_instance=false
*._db_writer_coalesce_area_size=16777216
*._disable_interface_checking=TRUE
*._enable_numa_support=FALSE
*._file_size_increase_increment=2143289344
*._fix_control='18960760:on'
*._gc_policy_time=20
*._gc_undo_affinity=TRUE
*.audit_file_dest='/u01/app/oracle/admin/awrdb_iad1wf/adump'
*.audit_sys_operations=TRUE
*.audit_trail='db'
*.common_user_prefix=''
*.compatible='19.0.0.0'
*.control_files='+RECO/AWRDB_IAD1WF/CONTROLFILE/current.256.1128887319'
*.control_management_pack_access='DIAGNOSTIC+TUNING'
*.cpu_count=0
*.cursor_sharing='EXACT'
*.db_block_checking='OFF'
*.db_block_checksum='TYPICAL'
*.db_block_size=8192
*.db_create_file_dest='+DATA'
*.db_create_online_log_dest_1='+RECO'
*.db_domain='sub01040135480.ashvcn.oraclevcn.com'
*.db_files=1024
*.db_lost_write_protect='TYPICAL'
*.db_name='awrdb'
*.db_recovery_file_dest='+RECO'
*.db_recovery_file_dest_size=255g
*.db_unique_name='awrdb_iad1wf'
*.diagnostic_dest='/u01/app/oracle'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=awrdbXDB)'
*.enable_ddl_logging=TRUE
*.enable_pluggable_database=true
*.encrypt_new_tablespaces='ALWAYS'
*.fast_start_mttr_target=300
*.filesystemio_options='setall'
*.global_names=TRUE
*.local_listener='LISTENER_AWRDB'
*.log_archive_format='%t_%s_%r.dbf'
*.log_buffer=134217728
*.nls_language='AMERICAN'
*.nls_territory='AMERICA'
*.open_cursors=1000
*.os_authent_prefix='ops$'
*.parallel_execution_message_size=16384
*.parallel_threads_per_cpu=2
*.pga_aggregate_limit=15616m
*.pga_aggregate_target=7808m
*.processes=800
*.remote_login_passwordfile='EXCLUSIVE'
*.session_cached_cursors=100
*.sga_target=31232m
*.spatial_vector_acceleration=TRUE
*.sql92_security=TRUE
*.tde_configuration='keystore_configuration=FILE'
*.undo_retention=900
*.undo_tablespace='UNDOTBS1'
*.use_large_pages='only'
*.wallet_root='/opt/oracle/dcs/commonstore/wallets/awrdb_iad1wf'

SQL> 

```


### Others


```
As ROOT
-------
# /u01/install/scripts/updatehosts.sh
# yum update
# hostname apps.example.com
# firewall-cmd --permanent --zone=public --add-port=4443/tcp
# firewall-cmd --reload
# sudo su - oracle
$ /u01/install/APPS/scripts/startdb.sh
$. /u01/install/APPS/EBSapps.env run
$ sh /u01/install/APPS/scripts/enableSYSADMIN.sh
$ /u01/install/APPS/scripts/enableDEMOusers.sh
$ cd $INST_TOP
$ mkdir certs
$ cd certs
$ mkdir Apache
$ cd Apache/
$ orapki wallet create -wallet . -auto_login -pwd Welcome123
$ orapki wallet add -wallet . -dn "CN=ebstest1.emeacloudpursuit.com,OU=Unit,O=Org,L=Redwood,ST=CA,C=US" -keysize 1024 -self_signed -validity 3650 -pwd Welcome123
$ cd $IAS_ORACLE_HOME/instances/EBS_web_OHS1/config/OHS/EBS_web/keystores/default/
$ cp /u01/install/APPS/fs1/inst/apps/ebsdb_apps/certs/Apache/cwallet.sso .
$ cd /u01/install/APPS/fs1/inst/apps/ebsdb_apps/certs/Apache
$ orapki wallet export -wallet $PWD -dn "CN=ebstest1.emeacloudpursuit.com,OU=Unit,O=Org,L=Redwood,ST=CA,C=US" -cert server.crt -pwd Welcome123
$ cd $OA_JRE_TOP/lib/security
$ cp cacerts cacerts_org
$ keytool -import -alias ApacheServer -file $INST_TOP/certs/Apache/server.crt -trustcacerts -v -keystore ./cacerts -storepass changeit
$ /u01/install/scripts/configwebentry.sh
		Enter the values for the following parameters to configure the Web Entry Point
		Enter the Web Entry Protocol (Eg: https/http):https
		Enter the Web Entry Host Name(Eg: public):ebstest1
		Enter the Web Entry Domain Name:(Eg: domain.com):emeacloudpursuit.com
		Enter the Web Entry Port:(Eg: 443/80):4443
		Enter the ORACLE_SID:(Eg: EBSDB):ebsdb
		**enter apps as APPS password when prompted**
$ /u01/install/APPS/scripts/startapps.sh
**TEST EBS ACCESS DIRECTLY** - Ensure 4443 is open on subnet security list for deployed EBS instance
		https://ebstest1.emeacloudpursuit.com:4443/OA_HTML/AppsLogin










./orapki wallet create -wallet /home/opc/oracle/wallet_dir/root_ca -auto_login -pwd Oracle12#
./orapki wallet add -wallet /home/opc/oracle/wallet_dir/root_ca -dn "CN=RootCA" -keysize 2048 -self_signed -validity 7300 -pwd Oracle12# -sign_alg sha256
./orapki wallet export -wallet /home/opc/oracle/wallet_dir/root_ca -dn "CN=RootCA" -cert /home/opc/oracle/wallet_dir/rootCA_Cert.pem -pwd Oracle12#
./orapki wallet create -wallet /home/opc/oracle/wallet_dir/ggsa -auto_login -pwd Oracle12#
./orapki wallet add -wallet /home/opc/oracle/wallet_dir/ggsa -dn "CN=opc" -keysize 2048 -pwd Oracle12#
./orapki wallet export -wallet /home/opc/oracle/wallet_dir/ggsa -dn "CN=opc" -request /home/opc/oracle/wallet_dir/servername_req.pem -pwd Oracle12#
./orapki cert create -wallet /home/opc/oracle/wallet_dir/root_ca -request /home/opc/oracle/wallet_dir/servername_req.pem -cert /home/opc/oracle/wallet_dir/servername_Cert1.pem -serial_num 20 -validity 375  -sign_alg sha256
./orapki wallet add -wallet /home/opc/oracle/wallet_dir/ggsa -trusted_cert -cert /home/opc/oracle/wallet_dir/rootCA_Cert.pem -pwd Oracle12#
./orapki cert create -wallet /home/opc/oracle/wallet_dir/root_ca -request /home/opc/oracle/wallet_dir/servername_req.pem -cert /home/opc/oracle/wallet_dir/servername_Cert.pem -serial_num 20 -validity 375  -sign_alg sha256
./orapki wallet add -wallet /home/opc/oracle/wallet_dir/ggsa -trusted_cert -cert /home/opc/oracle/wallet_dir/rootCA_Cert.pem -pwd Oracle12#
./orapki wallet add -wallet /home/opc/oracle/wallet_dir/ggsa -user_cert -cert /home/opc/oracle/wallet_dir/servername_Cert1.pem  -pwd Oracle12#  






./orapki wallet create -wallet /home/opc/oracle/wallet_dir/dist_client -auto_login -pwd Oracle12#


./orapki wallet add -wallet /home/opc/oracle/wallet_dir/dist_client -dn "CN=opc" -keysize 2048 -pwd Oracle12#


./orapki wallet export -wallet /home/opc/oracle/wallet_dir/dist_client -dn "CN=opc" -request /home/opc/oracle/wallet_dir/dist_client_req1.pem -pwd Oracle12#

./orapki cert create -wallet /home/opc/oracle/wallet_dir/root_ca -request /home/opc/oracle/wallet_dir/dist_client_req1.pem -cert /home/opc/oracle/wallet_dir/dist_client_Cert1.pem -serial_num 31 -validity 375 -pwd Oracle12#

./orapki wallet add -wallet /home/opc/oracle/wallet_dir/dist_client -trusted_cert -cert /home/opc/oracle/wallet_dir/rootCA_Cert.pem -pwd Oracle12#

./orapki wallet add -wallet /home/opc/oracle/wallet_dir/dist_client -user_cert -cert /home/opc/oracle/wallet_dir/dist_client_Cert1.pem -pwd Oracle12# 

```


