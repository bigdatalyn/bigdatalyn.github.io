

### InnoDB情况

当前innodb状态信息，但并不是实时状态信息

```
[root@ol8mysql ~]# mysql -e "show engine innodb status\G"
*************************** 1. row ***************************
  Type: InnoDB
  Name: 
Status: 
=====================================
2023-01-09 01:21:50 0x7f3a64231700 INNODB MONITOR OUTPUT
=====================================
Per second averages calculated from the last 18 seconds
-----------------
BACKGROUND THREAD
-----------------
srv_master_thread loops: 35 srv_active, 0 srv_shutdown, 15251 srv_idle
srv_master_thread log flush and writes: 15286
----------
SEMAPHORES
----------
OS WAIT ARRAY INFO: reservation count 6
OS WAIT ARRAY INFO: signal count 6
RW-shared spins 0, rounds 12, OS waits 6
RW-excl spins 0, rounds 0, OS waits 0
RW-sx spins 0, rounds 0, OS waits 0
Spin rounds per wait: 12.00 RW-shared, 0.00 RW-excl, 0.00 RW-sx
------------
TRANSACTIONS
------------
Trx id counter 3850
Purge done for trx's n:o < 0 undo n:o < 0 state: running but idle
History list length 0
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421363779458896, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421363779460720, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 3847, ACTIVE 214013 sec
2 lock struct(s), heap size 1136, 3 row lock(s), undo log entries 1
MySQL thread id 16, OS thread handle 139888764581632, query id 1513 localhost root
--------
FILE I/O
--------
I/O thread 0 state: waiting for completed aio requests (insert buffer thread)
I/O thread 1 state: waiting for completed aio requests (log thread)
I/O thread 2 state: waiting for completed aio requests (read thread)
I/O thread 3 state: waiting for completed aio requests (read thread)
I/O thread 4 state: waiting for completed aio requests (read thread)
I/O thread 5 state: waiting for completed aio requests (read thread)
I/O thread 6 state: waiting for completed aio requests (write thread)
I/O thread 7 state: waiting for completed aio requests (write thread)
I/O thread 8 state: waiting for completed aio requests (write thread)
I/O thread 9 state: waiting for completed aio requests (write thread)
Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,
 ibuf aio reads:, log i/o's:, sync i/o's:
Pending flushes (fsync) log: 0; buffer pool: 0
366 OS file reads, 261 OS file writes, 24 OS fsyncs
0.00 reads/s, 0 avg bytes/read, 0.00 writes/s, 0.00 fsyncs/s
-------------------------------------
INSERT BUFFER AND ADAPTIVE HASH INDEX
-------------------------------------
Ibuf: size 1, free list len 0, seg size 2, 0 merges
merged operations:
 insert 0, delete mark 0, delete 0
discarded operations:
 insert 0, delete mark 0, delete 0
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
0.00 hash searches/s, 0.00 non-hash searches/s
---
LOG
---
Log sequence number 29080743
Log flushed up to   29080743
Pages flushed up to 29080743
Last checkpoint at  29080734
0 pending log flushes, 0 pending chkp writes
21 log i/o's done, 0.00 log i/o's/second
----------------------
BUFFER POOL AND MEMORY
----------------------
Total large memory allocated 137428992
Dictionary memory allocated 157880
Buffer pool size   8192
Free buffers       7847
Database pages     345
Old database pages 0
Modified db pages  0
Pending reads      0
Pending writes: LRU 0, flush list 0, single page 0
Pages made young 0, not young 0
0.00 youngs/s, 0.00 non-youngs/s
Pages read 289, created 56, written 231
0.00 reads/s, 0.00 creates/s, 0.00 writes/s
No buffer pool page gets since the last printout
Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s
LRU len: 345, unzip_LRU len: 0
I/O sum[0]:cur[0], unzip sum[0]:cur[0]
--------------
ROW OPERATIONS
--------------
0 queries inside InnoDB, 0 queries in queue
0 read views open inside InnoDB
Process ID=1207, Main thread ID=139888359896832, state: sleeping
Number of rows inserted 4771, updated 1, deleted 0, read 4860
0.00 inserts/s, 0.00 updates/s, 0.00 deletes/s, 0.00 reads/s
----------------------------
END OF INNODB MONITOR OUTPUT
============================

[root@ol8mysql ~]# 
```

mysqld的进程号: 1207
```
[root@ol8mysql ~]# ps -ef | grep mysqld | grep -v grep
root         855       1  0 Jan08 ?        00:00:00 /bin/sh /usr/local/mysql/bin/mysqld_safe --datadir=/home/mysql --pid-file=/home/mysql/ol8mysql.pid
mysql       1207     855  0 Jan08 ?        00:00:11 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/home/mysql --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --log-error=ol8mysql.err --pid-file=/home/mysql/ol8mysql.pid --socket=/tmp/mysql5.7_3306.sock
[root@ol8mysql ~]# 
```

1207句柄deleted的文件
```
[root@ol8mysql ~]# ll /proc/1207/fd | grep deleted
lrwx------ 1 root root 64 Jan  6 13:23 12 -> /tmp/ibu2vtXE (deleted)
lrwx------ 1 root root 64 Jan  6 13:23 5 -> /tmp/ibmiQHc9 (deleted)
lrwx------ 1 root root 64 Jan  6 13:23 6 -> /tmp/ibIM38nl (deleted)
lrwx------ 1 root root 64 Jan  6 13:23 7 -> /tmp/ibhaxbxU (deleted)
lrwx------ 1 root root 64 Jan  6 13:23 8 -> /tmp/ibqACwYf (deleted)
[root@ol8mysql ~]# 
```

lsof查看mysqld句柄信息
```
[root@ol8mysql ~]# lsof -c mysqld | grep deleted
mysqld    1207 mysql    5u   REG              252,0      4210  67604150 /tmp/ibmiQHc9 (deleted)
mysqld    1207 mysql    6u   REG              252,0         0  67604151 /tmp/ibIM38nl (deleted)
mysqld    1207 mysql    7u   REG              252,0         0  67604152 /tmp/ibhaxbxU (deleted)
mysqld    1207 mysql    8u   REG              252,0         0  67604153 /tmp/ibqACwYf (deleted)
mysqld    1207 mysql   12u   REG              252,0         0  67604154 /tmp/ibu2vtXE (deleted)
[root@ol8mysql ~]# 
```

`/tmp/ibmiQHc9`的句柄是非空的(4210)
即`show engine innodb status`输出结果

```
[root@ol8mysql ~]# ll /proc/1207/fd/5
lrwx------ 1 root root 64 Jan  6 13:23 /proc/1207/fd/5 -> '/tmp/ibmiQHc9 (deleted)'
[root@ol8mysql ~]# cat /proc/1207/fd/5

=====================================
2023-01-09 01:23:41 0x7f3a64231700 INNODB MONITOR OUTPUT
=====================================
Per second averages calculated from the last 50 seconds
-----------------
BACKGROUND THREAD
-----------------
srv_master_thread loops: 35 srv_active, 0 srv_shutdown, 15362 srv_idle
srv_master_thread log flush and writes: 15397
----------
SEMAPHORES
----------
OS WAIT ARRAY INFO: reservation count 6
OS WAIT ARRAY INFO: signal count 6
RW-shared spins 0, rounds 12, OS waits 6
RW-excl spins 0, rounds 0, OS waits 0
RW-sx spins 0, rounds 0, OS waits 0
Spin rounds per wait: 12.00 RW-shared, 0.00 RW-excl, 0.00 RW-sx
------------
TRANSACTIONS
------------
Trx id counter 3850
Purge done for trx's n:o < 0 undo n:o < 0 state: running but idle
History list length 0
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421363779458896, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421363779460720, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 3847, ACTIVE 214124 sec
2 lock struct(s), heap size 1136, 3 row lock(s), undo log entries 1
MySQL thread id 16, OS thread handle 139888764581632, query id 1513 localhost root
--------
FILE I/O
--------
I/O thread 0 state: waiting for completed aio requests (insert buffer thread)
I/O thread 1 state: waiting for completed aio requests (log thread)
I/O thread 2 state: waiting for completed aio requests (read thread)
I/O thread 3 state: waiting for completed aio requests (read thread)
I/O thread 4 state: waiting for completed aio requests (read thread)
I/O thread 5 state: waiting for completed aio requests (read thread)
I/O thread 6 state: waiting for completed aio requests (write thread)
I/O thread 7 state: waiting for completed aio requests (write thread)
I/O thread 8 state: waiting for completed aio requests (write thread)
I/O thread 9 state: waiting for completed aio requests (write thread)
Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,
 ibuf aio reads:, log i/o's:, sync i/o's:
Pending flushes (fsync) log: 0; buffer pool: 0
366 OS file reads, 261 OS file writes, 24 OS fsyncs
0.00 reads/s, 0 avg bytes/read, 0.00 writes/s, 0.00 fsyncs/s
-------------------------------------
INSERT BUFFER AND ADAPTIVE HASH INDEX
-------------------------------------
Ibuf: size 1, free list len 0, seg size 2, 0 merges
merged operations:
 insert 0, delete mark 0, delete 0
discarded operations:
 insert 0, delete mark 0, delete 0
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
0.00 hash searches/s, 0.00 non-hash searches/s
---
LOG
---
Log sequence number 29080743
Log flushed up to   29080743
Pages flushed up to 29080743
Last checkpoint at  29080734
0 pending log flushes, 0 pending chkp writes
21 log i/o's done, 0.00 log i/o's/second
----------------------
BUFFER POOL AND MEMORY
----------------------
Total large memory allocated 137428992
Dictionary memory allocated 157880
Buffer pool size   8192
Free buffers       7847
Database pages     345
Old database pages 0
Modified db pages  0
Pending reads      0
Pending writes: LRU 0, flush list 0, single page 0
Pages made young 0, not young 0
0.00 youngs/s, 0.00 non-youngs/s
Pages read 289, created 56, written 231
0.00 reads/s, 0.00 creates/s, 0.00 writes/s
No buffer pool page gets since the last printout
Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s
LRU len: 345, unzip_LRU len: 0
I/O sum[0]:cur[0], unzip sum[0]:cur[0]
--------------
ROW OPERATIONS
--------------
0 queries inside InnoDB, 0 queries in queue
0 read views open inside InnoDB
Process ID=1207, Main thread ID=139888359896832, state: sleeping
Number of rows inserted 4771, updated 1, deleted 0, read 4860
0.00 inserts/s, 0.00 updates/s, 0.00 deletes/s, 0.00 reads/s
----------------------------
END OF INNODB MONITOR OUTPUT
============================
[root@ol8mysql ~]# 
```

通过上面句柄文件内容信息，定期查看innodb的状态信息

srv_master_thread: active表示数量增加和数据变化有关，与查询无关
通过active和idle可以获取系统整体负载情况，如果active越大，证明服务越繁忙
```
BACKGROUND THREAD
-----------------
srv_master_thread loops: 35 srv_active, 0 srv_shutdown, 15362 srv_idle
srv_master_thread log flush and writes: 15397
```


IO相关进程
```
FILE I/O
--------
I/O thread 0 state: waiting for completed aio requests (insert buffer thread)
I/O thread 1 state: waiting for completed aio requests (log thread)
I/O thread 2 state: waiting for completed aio requests (read thread)
I/O thread 3 state: waiting for completed aio requests (read thread)
I/O thread 4 state: waiting for completed aio requests (read thread)
I/O thread 5 state: waiting for completed aio requests (read thread)
I/O thread 6 state: waiting for completed aio requests (write thread)
I/O thread 7 state: waiting for completed aio requests (write thread)
I/O thread 8 state: waiting for completed aio requests (write thread)
I/O thread 9 state: waiting for completed aio requests (write thread)
Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,
 ibuf aio reads:, log i/o's:, sync i/o's:
Pending flushes (fsync) log: 0; buffer pool: 0
366 OS file reads, 261 OS file writes, 24 OS fsyncs
0.00 reads/s, 0 avg bytes/read, 0.00 writes/s, 0.00 fsyncs/s

read thread:4个（默认）write thread:4个（默认）
log thread / insert buffer thread 各1个
purge threads也是4个，如果执行truncate和drop操作，开启了多个purge thread回收空间，随着时间推移会使得数据恢复的难度大大增加。
page clearn是1个，可以按照实际情况调优（通过日志里面会有提示 page_cleaner延迟大，可以就行调整）

[root@ol8mysql ~]# mysql -e "show global variables like 'innodb_%_io_threads'"
+-------------------------+-------+
| Variable_name           | Value |
+-------------------------+-------+
| innodb_read_io_threads  | 4     |
| innodb_write_io_threads | 4     |
+-------------------------+-------+
[root@ol8mysql ~]#
[root@ol8mysql ~]# mysql -e "show global variables like 'innodb_purge_thread%'"
+----------------------+-------+
| Variable_name        | Value |
+----------------------+-------+
| innodb_purge_threads | 4     |
+----------------------+-------+
[root@ol8mysql ~]# mysql -e "show global variables like 'innodb_page_cleaners%'"
+----------------------+-------+
| Variable_name        | Value |
+----------------------+-------+
| innodb_page_cleaners | 1     |
+----------------------+-------+
[root@ol8mysql ~]# 
```

### LRU LIST

LRU LIST上面存放了数据页，就是Data pages数量
此外有Free Buffers

Data Pages和Free Buffer加起来跟Buffer pool size是不一致的
原因：其他缓冲池分配利用并不是LRU算法管理，如自适应hash索引，Lock信息等

LRU列表加了midpoint
传统LRU算法是当访问不到的页不在缓冲区直接将磁盘页数据调到缓冲区队列
InnoDB是插入到midpoint位置（lru列表的5/8处：黄金分割0.618很接近）
innodb_old_blocks_pct参数控制

```
[root@ol8mysql ~]# mysql -e "show global variables like 'innodb_old_block%'"
+------------------------+-------+
| Variable_name          | Value |
+------------------------+-------+
| innodb_old_blocks_pct  | 37    |
| innodb_old_blocks_time | 1000  |
+------------------------+-------+
[root@ol8mysql ~]# 
```

midpoint之前： new列表（young sublist/sublist of new block）63% 之后是old列表（old sublist/sublist of old block）

如果全表扫描加入sublist new block区域，整个lru就会有性能瓶颈，这种情况叫缓冲污染。
引入： innodb_old_blocks_time, 读取到mid位置之后需要等待多久才会被加入到LRU列表的热端，此参数保证热点数据不被轻易被刷出。默认是1000毫秒

### InnoDB日志

1.Redo日志：innodb的事务日志，保存在 ib_logfile*里面
2.undo日志，存放到共享表空间里面（ibdata*）

innodb处理时候，把相关的页加载到buffer pool里面，数据的变化写入到redo log buffer里面
事务提交时候会通过redo log buffer把数据变化些入redo log里面

innodb_flush_log_at_trx_commit:

| 参数选项 | 日志写入模式 | 刷盘模式 | 说明 | 特点 |
|:---:|:----:|:----:|:----|:----|
|0|延迟写日志|NA|log buffer每隔1秒写日志，数据刷盘|最快，存在数据丢失风险|
|1|实施写日志|实时刷盘|log buffer实时写日志，数据刷盘|最大安全性|
|2|延迟写日志|延迟刷盘|log buffer实时写日志，每隔1秒数据刷盘|较快，存在数据丢失风险|

在数据导入时候，为了提高性能，可以考虑临时调整innodb_flush_log_at_trx_commit为0，数据导入后，恢复为1


