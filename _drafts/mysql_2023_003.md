

### InnoDB情况

当前innodb状态信息，但并不是实时状态信息

```
[root@ol8mysql ~]# mysql -e "show engine innodb status\G"
*************************** 1. row ***************************
  Type: InnoDB
  Name: 
Status: 
=====================================
2023-01-09 01:21:50 0x7f3a64231700 INNODB MONITOR OUTPUT
=====================================
Per second averages calculated from the last 18 seconds
-----------------
BACKGROUND THREAD
-----------------
srv_master_thread loops: 35 srv_active, 0 srv_shutdown, 15251 srv_idle
srv_master_thread log flush and writes: 15286
----------
SEMAPHORES
----------
OS WAIT ARRAY INFO: reservation count 6
OS WAIT ARRAY INFO: signal count 6
RW-shared spins 0, rounds 12, OS waits 6
RW-excl spins 0, rounds 0, OS waits 0
RW-sx spins 0, rounds 0, OS waits 0
Spin rounds per wait: 12.00 RW-shared, 0.00 RW-excl, 0.00 RW-sx
------------
TRANSACTIONS
------------
Trx id counter 3850
Purge done for trx's n:o < 0 undo n:o < 0 state: running but idle
History list length 0
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421363779458896, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421363779460720, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 3847, ACTIVE 214013 sec
2 lock struct(s), heap size 1136, 3 row lock(s), undo log entries 1
MySQL thread id 16, OS thread handle 139888764581632, query id 1513 localhost root
--------
FILE I/O
--------
I/O thread 0 state: waiting for completed aio requests (insert buffer thread)
I/O thread 1 state: waiting for completed aio requests (log thread)
I/O thread 2 state: waiting for completed aio requests (read thread)
I/O thread 3 state: waiting for completed aio requests (read thread)
I/O thread 4 state: waiting for completed aio requests (read thread)
I/O thread 5 state: waiting for completed aio requests (read thread)
I/O thread 6 state: waiting for completed aio requests (write thread)
I/O thread 7 state: waiting for completed aio requests (write thread)
I/O thread 8 state: waiting for completed aio requests (write thread)
I/O thread 9 state: waiting for completed aio requests (write thread)
Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,
 ibuf aio reads:, log i/o's:, sync i/o's:
Pending flushes (fsync) log: 0; buffer pool: 0
366 OS file reads, 261 OS file writes, 24 OS fsyncs
0.00 reads/s, 0 avg bytes/read, 0.00 writes/s, 0.00 fsyncs/s
-------------------------------------
INSERT BUFFER AND ADAPTIVE HASH INDEX
-------------------------------------
Ibuf: size 1, free list len 0, seg size 2, 0 merges
merged operations:
 insert 0, delete mark 0, delete 0
discarded operations:
 insert 0, delete mark 0, delete 0
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
0.00 hash searches/s, 0.00 non-hash searches/s
---
LOG
---
Log sequence number 29080743
Log flushed up to   29080743
Pages flushed up to 29080743
Last checkpoint at  29080734
0 pending log flushes, 0 pending chkp writes
21 log i/o's done, 0.00 log i/o's/second
----------------------
BUFFER POOL AND MEMORY
----------------------
Total large memory allocated 137428992
Dictionary memory allocated 157880
Buffer pool size   8192
Free buffers       7847
Database pages     345
Old database pages 0
Modified db pages  0
Pending reads      0
Pending writes: LRU 0, flush list 0, single page 0
Pages made young 0, not young 0
0.00 youngs/s, 0.00 non-youngs/s
Pages read 289, created 56, written 231
0.00 reads/s, 0.00 creates/s, 0.00 writes/s
No buffer pool page gets since the last printout
Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s
LRU len: 345, unzip_LRU len: 0
I/O sum[0]:cur[0], unzip sum[0]:cur[0]
--------------
ROW OPERATIONS
--------------
0 queries inside InnoDB, 0 queries in queue
0 read views open inside InnoDB
Process ID=1207, Main thread ID=139888359896832, state: sleeping
Number of rows inserted 4771, updated 1, deleted 0, read 4860
0.00 inserts/s, 0.00 updates/s, 0.00 deletes/s, 0.00 reads/s
----------------------------
END OF INNODB MONITOR OUTPUT
============================

[root@ol8mysql ~]# 
```

mysqld的进程号: 1207
```
[root@ol8mysql ~]# ps -ef | grep mysqld | grep -v grep
root         855       1  0 Jan08 ?        00:00:00 /bin/sh /usr/local/mysql/bin/mysqld_safe --datadir=/home/mysql --pid-file=/home/mysql/ol8mysql.pid
mysql       1207     855  0 Jan08 ?        00:00:11 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/home/mysql --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --log-error=ol8mysql.err --pid-file=/home/mysql/ol8mysql.pid --socket=/tmp/mysql5.7_3306.sock
[root@ol8mysql ~]# 
```

1207句柄deleted的文件
```
[root@ol8mysql ~]# ll /proc/1207/fd | grep deleted
lrwx------ 1 root root 64 Jan  6 13:23 12 -> /tmp/ibu2vtXE (deleted)
lrwx------ 1 root root 64 Jan  6 13:23 5 -> /tmp/ibmiQHc9 (deleted)
lrwx------ 1 root root 64 Jan  6 13:23 6 -> /tmp/ibIM38nl (deleted)
lrwx------ 1 root root 64 Jan  6 13:23 7 -> /tmp/ibhaxbxU (deleted)
lrwx------ 1 root root 64 Jan  6 13:23 8 -> /tmp/ibqACwYf (deleted)
[root@ol8mysql ~]# 
```

lsof查看mysqld句柄信息
```
[root@ol8mysql ~]# lsof -c mysqld | grep deleted
mysqld    1207 mysql    5u   REG              252,0      4210  67604150 /tmp/ibmiQHc9 (deleted)
mysqld    1207 mysql    6u   REG              252,0         0  67604151 /tmp/ibIM38nl (deleted)
mysqld    1207 mysql    7u   REG              252,0         0  67604152 /tmp/ibhaxbxU (deleted)
mysqld    1207 mysql    8u   REG              252,0         0  67604153 /tmp/ibqACwYf (deleted)
mysqld    1207 mysql   12u   REG              252,0         0  67604154 /tmp/ibu2vtXE (deleted)
[root@ol8mysql ~]# 
```

`/tmp/ibmiQHc9`的句柄是非空的(4210)
即`show engine innodb status`输出结果

```
[root@ol8mysql ~]# ll /proc/1207/fd/5
lrwx------ 1 root root 64 Jan  6 13:23 /proc/1207/fd/5 -> '/tmp/ibmiQHc9 (deleted)'
[root@ol8mysql ~]# cat /proc/1207/fd/5

=====================================
2023-01-09 01:23:41 0x7f3a64231700 INNODB MONITOR OUTPUT
=====================================
Per second averages calculated from the last 50 seconds
-----------------
BACKGROUND THREAD
-----------------
srv_master_thread loops: 35 srv_active, 0 srv_shutdown, 15362 srv_idle
srv_master_thread log flush and writes: 15397
----------
SEMAPHORES
----------
OS WAIT ARRAY INFO: reservation count 6
OS WAIT ARRAY INFO: signal count 6
RW-shared spins 0, rounds 12, OS waits 6
RW-excl spins 0, rounds 0, OS waits 0
RW-sx spins 0, rounds 0, OS waits 0
Spin rounds per wait: 12.00 RW-shared, 0.00 RW-excl, 0.00 RW-sx
------------
TRANSACTIONS
------------
Trx id counter 3850
Purge done for trx's n:o < 0 undo n:o < 0 state: running but idle
History list length 0
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421363779458896, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421363779460720, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 3847, ACTIVE 214124 sec
2 lock struct(s), heap size 1136, 3 row lock(s), undo log entries 1
MySQL thread id 16, OS thread handle 139888764581632, query id 1513 localhost root
--------
FILE I/O
--------
I/O thread 0 state: waiting for completed aio requests (insert buffer thread)
I/O thread 1 state: waiting for completed aio requests (log thread)
I/O thread 2 state: waiting for completed aio requests (read thread)
I/O thread 3 state: waiting for completed aio requests (read thread)
I/O thread 4 state: waiting for completed aio requests (read thread)
I/O thread 5 state: waiting for completed aio requests (read thread)
I/O thread 6 state: waiting for completed aio requests (write thread)
I/O thread 7 state: waiting for completed aio requests (write thread)
I/O thread 8 state: waiting for completed aio requests (write thread)
I/O thread 9 state: waiting for completed aio requests (write thread)
Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,
 ibuf aio reads:, log i/o's:, sync i/o's:
Pending flushes (fsync) log: 0; buffer pool: 0
366 OS file reads, 261 OS file writes, 24 OS fsyncs
0.00 reads/s, 0 avg bytes/read, 0.00 writes/s, 0.00 fsyncs/s
-------------------------------------
INSERT BUFFER AND ADAPTIVE HASH INDEX
-------------------------------------
Ibuf: size 1, free list len 0, seg size 2, 0 merges
merged operations:
 insert 0, delete mark 0, delete 0
discarded operations:
 insert 0, delete mark 0, delete 0
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
Hash table size 34679, node heap has 0 buffer(s)
0.00 hash searches/s, 0.00 non-hash searches/s
---
LOG
---
Log sequence number 29080743
Log flushed up to   29080743
Pages flushed up to 29080743
Last checkpoint at  29080734
0 pending log flushes, 0 pending chkp writes
21 log i/o's done, 0.00 log i/o's/second
----------------------
BUFFER POOL AND MEMORY
----------------------
Total large memory allocated 137428992
Dictionary memory allocated 157880
Buffer pool size   8192
Free buffers       7847
Database pages     345
Old database pages 0
Modified db pages  0
Pending reads      0
Pending writes: LRU 0, flush list 0, single page 0
Pages made young 0, not young 0
0.00 youngs/s, 0.00 non-youngs/s
Pages read 289, created 56, written 231
0.00 reads/s, 0.00 creates/s, 0.00 writes/s
No buffer pool page gets since the last printout
Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s
LRU len: 345, unzip_LRU len: 0
I/O sum[0]:cur[0], unzip sum[0]:cur[0]
--------------
ROW OPERATIONS
--------------
0 queries inside InnoDB, 0 queries in queue
0 read views open inside InnoDB
Process ID=1207, Main thread ID=139888359896832, state: sleeping
Number of rows inserted 4771, updated 1, deleted 0, read 4860
0.00 inserts/s, 0.00 updates/s, 0.00 deletes/s, 0.00 reads/s
----------------------------
END OF INNODB MONITOR OUTPUT
============================
[root@ol8mysql ~]# 
```

通过上面句柄文件内容信息，定期查看innodb的状态信息

srv_master_thread: active表示数量增加和数据变化有关，与查询无关
通过active和idle可以获取系统整体负载情况，如果active越大，证明服务越繁忙
```
BACKGROUND THREAD
-----------------
srv_master_thread loops: 35 srv_active, 0 srv_shutdown, 15362 srv_idle
srv_master_thread log flush and writes: 15397
```


IO相关进程
```
FILE I/O
--------
I/O thread 0 state: waiting for completed aio requests (insert buffer thread)
I/O thread 1 state: waiting for completed aio requests (log thread)
I/O thread 2 state: waiting for completed aio requests (read thread)
I/O thread 3 state: waiting for completed aio requests (read thread)
I/O thread 4 state: waiting for completed aio requests (read thread)
I/O thread 5 state: waiting for completed aio requests (read thread)
I/O thread 6 state: waiting for completed aio requests (write thread)
I/O thread 7 state: waiting for completed aio requests (write thread)
I/O thread 8 state: waiting for completed aio requests (write thread)
I/O thread 9 state: waiting for completed aio requests (write thread)
Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,
 ibuf aio reads:, log i/o's:, sync i/o's:
Pending flushes (fsync) log: 0; buffer pool: 0
366 OS file reads, 261 OS file writes, 24 OS fsyncs
0.00 reads/s, 0 avg bytes/read, 0.00 writes/s, 0.00 fsyncs/s

read thread:4个（默认）write thread:4个（默认）
log thread / insert buffer thread 各1个
purge threads也是4个，如果执行truncate和drop操作，开启了多个purge thread回收空间，随着时间推移会使得数据恢复的难度大大增加。
page clearn是1个，可以按照实际情况调优（通过日志里面会有提示 page_cleaner延迟大，可以就行调整）

[root@ol8mysql ~]# mysql -e "show global variables like 'innodb_%_io_threads'"
+-------------------------+-------+
| Variable_name           | Value |
+-------------------------+-------+
| innodb_read_io_threads  | 4     |
| innodb_write_io_threads | 4     |
+-------------------------+-------+
[root@ol8mysql ~]#
[root@ol8mysql ~]# mysql -e "show global variables like 'innodb_purge_thread%'"
+----------------------+-------+
| Variable_name        | Value |
+----------------------+-------+
| innodb_purge_threads | 4     |
+----------------------+-------+
[root@ol8mysql ~]# mysql -e "show global variables like 'innodb_page_cleaners%'"
+----------------------+-------+
| Variable_name        | Value |
+----------------------+-------+
| innodb_page_cleaners | 1     |
+----------------------+-------+
[root@ol8mysql ~]# 
```

### LRU LIST

LRU LIST上面存放了数据页，就是Data pages数量
此外有Free Buffers

Data Pages和Free Buffer加起来跟Buffer pool size是不一致的
原因：其他缓冲池分配利用并不是LRU算法管理，如自适应hash索引，Lock信息等

LRU列表加了midpoint
传统LRU算法是当访问不到的页不在缓冲区直接将磁盘页数据调到缓冲区队列
InnoDB是插入到midpoint位置（lru列表的5/8处：黄金分割0.618很接近）
innodb_old_blocks_pct参数控制

```
[root@ol8mysql ~]# mysql -e "show global variables like 'innodb_old_block%'"
+------------------------+-------+
| Variable_name          | Value |
+------------------------+-------+
| innodb_old_blocks_pct  | 37    |
| innodb_old_blocks_time | 1000  |
+------------------------+-------+
[root@ol8mysql ~]# 
```

midpoint之前： new列表（young sublist/sublist of new block）63% 之后是old列表（old sublist/sublist of old block）

如果全表扫描加入sublist new block区域，整个lru就会有性能瓶颈，这种情况叫缓冲污染。
引入： innodb_old_blocks_time, 读取到mid位置之后需要等待多久才会被加入到LRU列表的热端，此参数保证热点数据不被轻易被刷出。默认是1000毫秒

### InnoDB日志

1.Redo日志：innodb的事务日志，保存在 ib_logfile*里面
2.undo日志，存放到共享表空间里面（ibdata*）

innodb处理时候，把相关的页加载到buffer pool里面，数据的变化写入到redo log buffer里面
事务提交时候会通过redo log buffer把数据变化些入redo log里面

innodb_flush_log_at_trx_commit:

| 参数选项 | 日志写入模式 | 刷盘模式 | 说明 | 特点 |
|:---:|:----:|:----:|:----|:----|
|0|延迟写日志|NA|log buffer每隔1秒写日志，数据刷盘|最快，存在数据丢失风险|
|1|实施写日志|实时刷盘|log buffer实时写日志，数据刷盘|最大安全性|
|2|延迟写日志|延迟刷盘|log buffer实时写日志，每隔1秒数据刷盘|较快，存在数据丢失风险|

在数据导入时候，为了提高性能，可以考虑临时调整innodb_flush_log_at_trx_commit为0，数据导入后，恢复为1


### pt-variable-advisor 给出数据库优化参数建议

```
[root@ol8mysql ~]# pt-variable-advisor localhost -uroot -pmysql
# WARN delay_key_write: MyISAM index blocks are never flushed until necessary.

# NOTE init_connect: The init_connect option is enabled on this server.

# WARN innodb_flush_log_at_trx_commit-1: InnoDB is not configured in strictly ACID mode.

# WARN innodb_flush_log_at_trx_commit-2: Setting innodb_flush_log_at_trx_commit to 0 has no performance benefits over setting it to 2, and more types of data loss are possible.

# WARN key_buffer_size: The key buffer size is set to its default value, which is not good  for most production systems.

# NOTE sort_buffer_size-1: The sort_buffer_size variable should generally be left at its default unless an expert determines it is necessary to change it.

# NOTE innodb_data_file_path: Auto-extending InnoDB files can consume a lot of disk space that is very difficult to reclaim later.

# NOTE innodb_flush_method: Most production database servers that use InnoDB should set innodb_flush_method to O_DIRECT to avoid double-buffering, unless the I/O system is very low performance.

# WARN myisam_recover_options: myisam_recover_options should be set to some value such as BACKUP,FORCE to ensure that table corruption is noticed.

[root@ol8mysql ~]# 
```

### pt-show-grants 迁移用户

迁移用户权限列表

```
[root@ol8mysql ~]# pt-show-grants -hlocalhost -uroot -pmysql
-- Grants dumped by pt-show-grants
-- Dumped from server Localhost via UNIX socket, MySQL 5.7.40-log at 2023-01-09 06:31:33
-- Grants for 'mysql.session'@'localhost'
CREATE USER IF NOT EXISTS 'mysql.session'@'localhost';
ALTER USER 'mysql.session'@'localhost' IDENTIFIED WITH 'mysql_native_password' AS '*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE' REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT LOCK;
GRANT SELECT ON `mysql`.`user` TO 'mysql.session'@'localhost';
GRANT SELECT ON `performance_schema`.* TO 'mysql.session'@'localhost';
GRANT SUPER ON *.* TO 'mysql.session'@'localhost';
-- Grants for 'mysql.sys'@'localhost'
CREATE USER IF NOT EXISTS 'mysql.sys'@'localhost';
ALTER USER 'mysql.sys'@'localhost' IDENTIFIED WITH 'mysql_native_password' AS '*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE' REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT LOCK;
GRANT SELECT ON `sys`.`sys_config` TO 'mysql.sys'@'localhost';
GRANT TRIGGER ON `sys`.* TO 'mysql.sys'@'localhost';
GRANT USAGE ON *.* TO 'mysql.sys'@'localhost';
-- Grants for 'repl'@'%'
CREATE USER IF NOT EXISTS 'repl'@'%';
ALTER USER 'repl'@'%' IDENTIFIED WITH 'mysql_native_password' AS '*79B3BB271E6122BBD7264943C17265262F38B236' REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT UNLOCK;
GRANT REPLICATION CLIENT, REPLICATION SLAVE ON *.* TO 'repl'@'%';
-- Grants for 'root'@'localhost'
CREATE USER IF NOT EXISTS 'root'@'localhost';
ALTER USER 'root'@'localhost' IDENTIFIED WITH 'mysql_native_password' AS '*E74858DB86EBA20BC33D0AECAE8A8108C56B17FA' REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT UNLOCK;
GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION;
GRANT PROXY ON ''@'' TO 'root'@'localhost' WITH GRANT OPTION;
[root@ol8mysql ~]# 
```

### pt-summary 查看系统状态总览

```
[root@ol8mysql ~]# pt-summary
# Percona Toolkit System Summary Report ######################
        Date | 2023-01-09 06:34:05 UTC (local TZ: UTC +0000)
    Hostname | ol8mysql
      Uptime |  9:27,  3 users,  load average: 0.05, 0.02, 0.00
      System | innotek GmbH; VirtualBox; v1.2 (Other)
 Service Tag | 0
    Platform | Linux
     Release | Red Hat Enterprise Linux release 8.6 (Ootpa)
      Kernel | 5.4.17-2136.309.4.el8uek.x86_64
Architecture | CPU = 64-bit, OS = 64-bit
   Threading | NPTL 2.28
    Compiler | GNU CC version 8.5.0 20210514 (Red Hat 8.5.0-10.0.2).
     SELinux | Disabled
 Virtualized | No virtualization detected
# Processor ##################################################
  Processors | physical = 1, cores = 1, virtual = 1, hyperthreading = no
      Speeds | 1x2314.300
      Models | 1xIntel(R) Core(TM) i7-1068NG7 CPU @ 2.30GHz
      Caches | 1x8192 KB
# Memory #####################################################
       Total | 1.9G
        Free | 411.3M
        Used | physical = 556.2M, swap allocated = 4.0G, swap used = 11.8M, virtual = 567.9M
      Shared | 8.4M
     Buffers | 1005.3M
      Caches | 1.2G
       Dirty | 88 kB
     UsedRSS | 616.1M
  Swappiness | 60
 DirtyPolicy | 20, 10
 DirtyStatus | 0, 0
  Locator   Size     Speed             Form Factor   Type          Type Detail
  ========= ======== ================= ============= ============= ===========
# Mounted Filesystems ########################################
  Filesystem                   Size Used Type     Opts                                                             Mountpoint
  /dev/mapper/vg_main-lv_root   33G  24% xfs      rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota         /
  /dev/sda1                    495M  22% xfs      rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota         /boot
  devtmpfs                     956M   0% devtmpfs rw,nosuid,size=978368k,nr_inodes=244592,mode=755                 /dev
  tmpfs                        198M   0% tmpfs    rw,nosuid,nodev                                                  /run/user/1000
  tmpfs                        198M   0% tmpfs    rw,nosuid,nodev,mode=755                                         /run/user/1000
  tmpfs                        198M   0% tmpfs    rw,nosuid,nodev,relatime,size=202012k,mode=700,uid=1000,gid=1000 /run/user/1000
  tmpfs                        198M   0% tmpfs    ro,nosuid,nodev,noexec,mode=755                                  /run/user/1000
  tmpfs                        987M   0% tmpfs    rw,nosuid,nodev                                                  /dev/shm
  tmpfs                        987M   0% tmpfs    rw,nosuid,nodev,mode=755                                         /dev/shm
  tmpfs                        987M   0% tmpfs    rw,nosuid,nodev,relatime,size=202012k,mode=700,uid=1000,gid=1000 /dev/shm
  tmpfs                        987M   0% tmpfs    ro,nosuid,nodev,noexec,mode=755                                  /dev/shm
  tmpfs                        987M   0% tmpfs    rw,nosuid,nodev                                                  /sys/fs/cgroup
  tmpfs                        987M   0% tmpfs    rw,nosuid,nodev,mode=755                                         /sys/fs/cgroup
  tmpfs                        987M   0% tmpfs    rw,nosuid,nodev,relatime,size=202012k,mode=700,uid=1000,gid=1000 /sys/fs/cgroup
  tmpfs                        987M   0% tmpfs    ro,nosuid,nodev,noexec,mode=755                                  /sys/fs/cgroup
  tmpfs                        987M   2% tmpfs    rw,nosuid,nodev                                                  /run
  tmpfs                        987M   2% tmpfs    rw,nosuid,nodev,mode=755                                         /run
  tmpfs                        987M   2% tmpfs    rw,nosuid,nodev,relatime,size=202012k,mode=700,uid=1000,gid=1000 /run
  tmpfs                        987M   2% tmpfs    ro,nosuid,nodev,noexec,mode=755                                  /run
  vagrant                      466G  51% vboxsf   rw,nodev,relatime,iocharset=utf8,uid=1000,gid=1000,_netdev       /vagrant
# Disk Schedulers And Queue Size #############################
        dm-0 | 128
        dm-1 | 128
         sda | [mq-deadline] 64
# Disk Partioning ############################################
Device       Type      Start        End               Size
============ ==== ========== ========== ==================
/dev/dm-0    Disk                              34904997888
/dev/dm-1    Disk                               4294967296
/dev/sda     Disk                              39728447488
/dev/sda1    Part       2048    1026047                  0
/dev/sda2    Part    1026048   77594623                  0
# Kernel Inode State #########################################
dentry-state | 74825	52307	45	0	5344	0
     file-nr | 1568	0	195320
    inode-nr | 102640	33712
# LVM Volumes ################################################
  LV      VG      Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lv_root vg_main -wi-ao---- <32.51g                                                    
  lv_swap vg_main -wi-ao----   4.00g                                                    
# LVM Volume Groups ##########################################
  VG      VSize   VFree
  vg_main <36.51g    0 
# RAID Controller ############################################
  Controller | No RAID controller detected
# Network Config #############################################
 FIN Timeout | 60
  Port Range | 60999
# Interface Statistics #######################################
  interface  rx_bytes rx_packets  rx_errors   tx_bytes tx_packets  tx_errors
  ========= ========= ========== ========== ========== ========== ==========
  lo          3000000      30000          0    3000000      30000          0
  eth0       45000000      50000          0    1750000      17500          0
  eth1           9000         90          0       2500         35          0
  eth2        5000000      15000          0      30000        450          0
# Network Devices ############################################
  Device    Speed     Duplex
  ========= ========= =========
  eth0       Unknown!   Unknown!  
  eth1       1000Mb/s   Full      
  eth2       1000Mb/s   Full      
# Top Processes ##############################################
    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
      1 root      20   0  172528  10576   8088 S   0.0   0.5   0:01.72 systemd
      2 root      20   0       0      0      0 S   0.0   0.0   0:00.00 kthreadd
      3 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_gp
      4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_par+
      6 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
      8 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 mm_perc+
      9 root      20   0       0      0      0 S   0.0   0.0   0:03.41 ksoftir+
     10 root      20   0       0      0      0 I   0.0   0.0   0:00.31 rcu_sch+
     11 root      rt   0       0      0      0 S   0.0   0.0   0:00.37 migrati+
# Notable Processes ##########################################
  PID    OOM    COMMAND
  770    -17    sshd
# Simplified and fuzzy rounded vmstat (wait please) ##########
  procs  ---swap-- -----io---- ---system---- --------cpu--------
   r  b    si   so    bi    bo     ir     cs  us  sy  il  wa  st
   1  0     0    0    25   100     80    225   0   2  98   0   0
   0  0     0    0     0    30    400   1500   1   9  90   0   0
   0  0     0    0     0     0     60    125   0   2  98   0   0
   0  0     0    0     0    15     70    125   0   1  99   0   0
   0  0     0    0     0     0     70    125   0   2  98   0   0
# Memory mamagement ##########################################
Transparent huge pages are enabled.
# The End ####################################################
[root@ol8mysql ~]# 
```

### pt 工具

Ref

[MySQL PT工具使用](https://zhuanlan.zhihu.com/p/162730892)


### sysbench

[通过sysbench工具实现MySQL数据库的性能测试](https://www.cnblogs.com/xuliuzai/p/11243376.html)

[How to Benchmark Performance of MySQL Using SysBench](https://ittutorial.org/how-to-benchmark-performance-of-mysql-using-sysbench/)

[Using sysbench 0.5 for performing MySQL benchmarks](https://www.percona.com/blog/2014/09/02/using-sysbench-0-5-benchmark-mysql-whats-changed-latest-release/)

[How to Benchmark Your System (CPU, File IO, MySQL) with Sysbench](https://www.howtoforge.com/how-to-benchmark-your-system-cpu-file-io-mysql-with-sysbench)


```
sysbench oltp_read_write.lua --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-db=sbtest --mysql-user=root --mysql-password=123456 --table_size=200000000 --tables=1 --threads=500 --events=500000 --report-interval=10 --time=0
# 如果执行的时候提示FATAL: Cannot find benchmark 'oltp_read_write.lua': no such built-in test, file or module
切换到sysbench的源码目录（sysbench.tar.gz解压路径）
find ./ -name oltp_read_write.lua
./src/lua/oltp_read_write.lua
接着切换到src/lua 目录再执行语句
#如果执行的时候命令行提示“Can not connect to MySQL server. Too many connections”-mysql 1040错误：
shell>mysql -uroot -p****
mysql>show variables like 'max_connections';(查看当前的最大连接数)
mysql>set global max_connections=1000;(设置最大连接数为1000，可以再次查看是否设置成功)
mysql>show variables like 'max_connections';(查看当前的最大连接数)
mysql>exit

--mysql-host    IP
--mysql-port    端口号
--mysql-db  希望链接的数据库
--mysql-user    用户名
--mysql-password    密码
--table_size    每张表初始化的数据数量
--tables    初始化表的数量
--threads   启动的线程
--time  运行时间设为0表示不限制时间
--report-interval   运行期间日志，单位为秒
--events    最大请求数量，定义数量后可以不需要--time选项

```

```
写好上面的语句
在上面的语句后面加上 prepare，执行
在上面的语句后面加上 run，执行
在上面的语句后面加上 cleanup，执行
prepare用于准备测试需要的数据，准备完后执行run来测试，测试完成后不要忘记执行cleanup来清楚测试数据
```


#### sysbench 测试CPU

```
[root@ol8mysql ~]# sysbench --test=cpu --cpu-max-prime=10000 run
sysbench 0.4.12.10:  multi-threaded system evaluation benchmark

Running the test with following options:
Number of threads: 1
Random number generator seed is 0 and will be ignored


Doing CPU performance benchmark

Primer numbers limit: 10000

Threads started!
Done.


General statistics:
    total time:                          3.6167s
    total number of events:              10000
    total time taken by event execution: 3.6040
    response time:
         min:                                  0.30ms
         avg:                                  0.36ms
         max:                                  4.55ms
         approx.  95 percentile:               0.59ms

Threads fairness:
    events (avg/stddev):           10000.0000/0.00
    execution time (avg/stddev):   3.6040/0.00

[root@ol8mysql ~]# 
```
确认比较
```
    total time:                          3.6167s
```

#### File IO测试

准备2g数据文件
```
sysbench --test=fileio --file-total-size=2G prepare
```
示例:
```
[root@ol8mysql ~]# sysbench --test=fileio --file-total-size=2G prepare
sysbench 0.4.12.10:  multi-threaded system evaluation benchmark

128 files, 16384Kb each, 2048Mb total
Creating files for the test...
Extra file open flags: 0
Creating file test_file.0
Creating file test_file.1
Creating file test_file.2
Creating file test_file.3
Creating file test_file.4
Creating file test_file.5
Creating file test_file.6
Creating file test_file.7
Creating file test_file.8
Creating file test_file.9
Creating file test_file.10
Creating file test_file.11
Creating file test_file.12
Creating file test_file.13
Creating file test_file.14
Creating file test_file.15
Creating file test_file.16
Creating file test_file.17
Creating file test_file.18
Creating file test_file.19
Creating file test_file.20
Creating file test_file.21
Creating file test_file.22
Creating file test_file.23
Creating file test_file.24
Creating file test_file.25
Creating file test_file.26
Creating file test_file.27
Creating file test_file.28
Creating file test_file.29
Creating file test_file.30
Creating file test_file.31
Creating file test_file.32
Creating file test_file.33
Creating file test_file.34
Creating file test_file.35
Creating file test_file.36
Creating file test_file.37
Creating file test_file.38
Creating file test_file.39
Creating file test_file.40
Creating file test_file.41
Creating file test_file.42
Creating file test_file.43
Creating file test_file.44
Creating file test_file.45
Creating file test_file.46
Creating file test_file.47
Creating file test_file.48
Creating file test_file.49
Creating file test_file.50
Creating file test_file.51
Creating file test_file.52
Creating file test_file.53
Creating file test_file.54
Creating file test_file.55
Creating file test_file.56
Creating file test_file.57
Creating file test_file.58
Creating file test_file.59
Creating file test_file.60
Creating file test_file.61
Creating file test_file.62
Creating file test_file.63
Creating file test_file.64
Creating file test_file.65
Creating file test_file.66
Creating file test_file.67
Creating file test_file.68
Creating file test_file.69
Creating file test_file.70
Creating file test_file.71
Creating file test_file.72
Creating file test_file.73
Creating file test_file.74
Creating file test_file.75
Creating file test_file.76
Creating file test_file.77
Creating file test_file.78
Creating file test_file.79
Creating file test_file.80
Creating file test_file.81
Creating file test_file.82
Creating file test_file.83
Creating file test_file.84
Creating file test_file.85
Creating file test_file.86
Creating file test_file.87
Creating file test_file.88
Creating file test_file.89
Creating file test_file.90
Creating file test_file.91
Creating file test_file.92
Creating file test_file.93
Creating file test_file.94
Creating file test_file.95
Creating file test_file.96
Creating file test_file.97
Creating file test_file.98
Creating file test_file.99
Creating file test_file.100
Creating file test_file.101
Creating file test_file.102
Creating file test_file.103
Creating file test_file.104
Creating file test_file.105
Creating file test_file.106
Creating file test_file.107
Creating file test_file.108
Creating file test_file.109
Creating file test_file.110
Creating file test_file.111
Creating file test_file.112
Creating file test_file.113
Creating file test_file.114
Creating file test_file.115
Creating file test_file.116
Creating file test_file.117
Creating file test_file.118
Creating file test_file.119
Creating file test_file.120
Creating file test_file.121
Creating file test_file.122
Creating file test_file.123
Creating file test_file.124
Creating file test_file.125
Creating file test_file.126
Creating file test_file.127
2147483648 bytes written in 7.50 seconds (272.99 MB/sec).
[root@ol8mysql ~]# 
```

测试:
```
sysbench --test=fileio --file-total-size=2G --file-test-mode=rndrw --init-rng=on --max-time=10 --max-requests=0 run
```
示例:
```
[root@ol8mysql ~]# sysbench --test=fileio --file-total-size=2G --file-test-mode=rndrw --init-rng=on --max-time=10 --max-requests=0 run
sysbench 0.4.12.10:  multi-threaded system evaluation benchmark

Running the test with following options:
Number of threads: 1
Initializing random number generator from timer.

Random number generator seed is 0 and will be ignored


Extra file open flags: 0
128 files, 16Mb each
2Gb total file size
Block size 16Kb
Number of random requests for random IO: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Threads started!
Time limit exceeded, exiting...
Done.

Operations performed:  10980 reads, 7320 writes, 23307 Other = 41607 Total
Read 171.56Mb  Written 114.38Mb  Total transferred 285.94Mb  (28.592Mb/sec)
 1829.89 Requests/sec executed

General statistics:
    total time:                          10.0006s
    total number of events:              18300
    total time taken by event execution: 1.5808
    response time:
         min:                                  0.00ms
         avg:                                  0.09ms
         max:                                  9.79ms
         approx.  95 percentile:               0.37ms

Threads fairness:
    events (avg/stddev):           18300.0000/0.00
    execution time (avg/stddev):   1.5808/0.00

[root@ol8mysql ~]# 
```
read/write速率：
```
Read 171.56Mb  Written 114.38Mb  Total transferred 285.94Mb  (28.592Mb/sec)
```

删除:
```
sysbench --test=fileio --file-total-size=2G cleanup

[root@ol8mysql ~]# sysbench --test=fileio --file-total-size=2G cleanup
sysbench 0.4.12.10:  multi-threaded system evaluation benchmark

Removing test files...
[root@ol8mysql ~]# 
```


#### MySQL测试


```
mysql> create database sbtest;
Query OK, 1 row affected (0.02 sec)

mysql> create user sbtest_user identified by 'sbtest_user';
Query OK, 0 rows affected (0.03 sec)

mysql> grant all on sbtest.* to `sbtest_user`@`%`;
Query OK, 0 rows affected (0.01 sec)

mysql> show grants for sbtest_user;
+---------------------------------------------------------+
| Grants for sbtest_user@%                                |
+---------------------------------------------------------+
| GRANT USAGE ON *.* TO 'sbtest_user'@'%'                 |
| GRANT ALL PRIVILEGES ON `sbtest`.* TO 'sbtest_user'@'%' |
+---------------------------------------------------------+
2 rows in set (0.00 sec)

mysql> 

mysql>show variables like 'max_connections';(查看当前的最大连接数)
mysql>set global max_connections=1000;(设置最大连接数为1000，可以再次查看是否设置成功)
mysql>show variables like 'max_connections';(查看当前的最大连接数)
```

准备:
```

sysbench --test=oltp --oltp-table-size=1000000 --db-driver=mysql --mysql-host=127.0.0.1 --mysql-db=sbtest --mysql-user=sbtest_user --mysql-password=sbtest_user --mysql-port=3306 prepare

[root@ol8mysql ~]# sysbench --test=oltp --oltp-table-size=1000000 --db-driver=mysql --mysql-host=127.0.0.1 --mysql-db=sbtest --mysql-user=sbtest_user --mysql-password=sbtest_user --mysql-port=3306 prepare
sysbench 0.4.12.10:  multi-threaded system evaluation benchmark

Creating table 'sbtest'...
Creating 1000000 records in table 'sbtest'...
[root@ol8mysql ~]# 
```

```
--mysql-host    IP
--mysql-port    端口号
--mysql-db  希望链接的数据库
--mysql-user    用户名
--mysql-password    密码
```

测试:
```
sysbench --test=oltp --oltp-table-size=1000000 --db-driver=mysql --mysql-host=127.0.0.1 --mysql-db=sbtest --mysql-user=sbtest_user --mysql-password=sbtest_user --mysql-port=3306 --max-time=60 --oltp-read-only=on --max-requests=0 --num-threads=4 run


[root@ol8mysql ~]# sysbench --test=oltp --oltp-table-size=1000000 --db-driver=mysql --mysql-host=127.0.0.1 --mysql-db=sbtest --mysql-user=sbtest_user --mysql-password=sbtest_user --mysql-port=3306 --max-time=60 --oltp-read-only=on --max-requests=0 --num-threads=4 run
sysbench 0.4.12.10:  multi-threaded system evaluation benchmark

Running the test with following options:
Number of threads: 4
Random number generator seed is 0 and will be ignored


Doing OLTP test.
Running mixed OLTP test
Doing read-only test
Using Special distribution (12 iterations,  1 pct of values are returned in 75 pct cases)
Using "BEGIN" for starting transactions
Using auto_inc on the id column
Using 1 test tables
Threads started!
Time limit exceeded, exiting...
(last message repeated 3 times)
Done.

OLTP test statistics:
    queries performed:
        read:                            629566
        write:                           0
        other:                           89938
        total:                           719504
    transactions:                        44969  (749.42 per sec.)
    deadlocks:                           0      (0.00 per sec.)
    read/write requests:                 629566 (10491.90 per sec.)
    other operations:                    89938  (1498.84 per sec.)

General statistics:
    total time:                          60.0050s
    total number of events:              44969
    total time taken by event execution: 239.8254
    response time:
         min:                                  1.02ms
         avg:                                  5.33ms
         max:                                 82.70ms
         approx.  95 percentile:               7.64ms

Threads fairness:
    events (avg/stddev):           11242.2500/40.65
    execution time (avg/stddev):   59.9564/0.01

[root@ol8mysql ~]# 
```

查看 transactions
```
    transactions:                        44969  (749.42 per sec.)
```

清理cleanup
```
sysbench --test=oltp --oltp-table-size=1000000 --db-driver=mysql --mysql-host=127.0.0.1 --mysql-db=sbtest --mysql-user=sbtest_user --mysql-password=sbtest_user --mysql-port=3306 clearnup
```

创建4个测试表
```
sysbench --test=oltp --oltp-table-size=1000000 --db-driver=mysql --mysql-host=127.0.0.1 --mysql-db=sbtest --mysql-user=sbtest_user --mysql-password=sbtest_user --mysql-port=3306 --oltp-num-tables=4 prepare

[root@ol8mysql ~]# sysbench --test=oltp --oltp-table-size=1000000 --db-driver=mysql --mysql-host=127.0.0.1 --mysql-db=sbtest --mysql-user=sbtest_user --mysql-password=sbtest_user --mysql-port=3306 --oltp-num-tables=4 prepare
sysbench 0.4.12.10:  multi-threaded system evaluation benchmark

Creating table 'sbtest3'...
Creating table 'sbtest1'...
Creating table 'sbtest2'...
Creating table 'sbtest'...
Creating 1000000 records in table 'sbtest2'...
Creating 1000000 records in table 'sbtest1'...
Creating 1000000 records in table 'sbtest'...
Creating 1000000 records in table 'sbtest3'...

[root@ol8mysql ~]# 
```

[mysql性能测试工具：sysbench](https://segmentfault.com/a/1190000015241184)
sysbench oltp help:
```
[root@ol8mysql ~]# sysbench --test=oltp help
sysbench 0.4.12.10:  multi-threaded system evaluation benchmark

oltp options:
  --oltp-test-mode=STRING                  test type to use {simple,complex,nontrx,sp} [complex]
  --oltp-reconnect-mode=STRING             reconnect mode {session,transaction,query,random} [session]
  --oltp-sp-name=STRING                    name of store procedure to call in SP test mode []
  --oltp-read-only=[on|off]                generate only 'read' queries (do not modify database) [off]
  --oltp-avoid-deadlocks=[on|off]          generate update keys in increasing order to avoid deadlocks [off]
  --oltp-skip-trx=[on|off]                 skip BEGIN/COMMIT statements [off]
  --oltp-range-size=N                      range size for range queries [100]
  --oltp-point-selects=N                   number of point selects [10]
  --oltp-use-in-statement=N                Use IN-statement with 10 PK lookups per query [0]
  --oltp-use-filter=[on|off]               Use filters in range queries [off]
  --oltp-simple-ranges=N                   number of simple ranges [1]
  --oltp-sum-ranges=N                      number of sum ranges [1]
  --oltp-order-ranges=N                    number of ordered ranges [1]
  --oltp-distinct-ranges=N                 number of distinct ranges [1]
  --oltp-index-updates=N                   number of index update [1]
  --oltp-non-index-updates=N               number of non-index updates [1]
  --oltp-nontrx-mode=STRING                mode for non-transactional test {select, update_key, update_nokey, insert, delete} [select]
  --oltp-auto-inc=[on|off]                 whether AUTO_INCREMENT (or equivalent) should be used on id column [on]
  --oltp-connect-delay=N                   time in microseconds to sleep after connection to database [10000]
  --oltp-user-delay-min=N                  minimum time in microseconds to sleep after each request [0]
  --oltp-user-delay-max=N                  maximum time in microseconds to sleep after each request [0]
  --oltp-table-comment-string=STRING       comment on table []
  --oltp-table-name=STRING                 name of test table [sbtest]
  --oltp-table-size=N                      number of records in test table [10000]
  --oltp-dist-type=STRING                  random numbers distribution {uniform,gaussian,special} [special]
  --oltp-dist-iter=N                       number of iterations used for numbers generation [12]
  --oltp-dist-pct=N                        percentage of values to be treated as 'special' (for special distribution) [1]
  --oltp-dist-res=N                        percentage of 'special' values to use (for special distribution) [75]
  --oltp-point-select-mysql-handler=[on|off]Use MySQL HANDLER for point select [off]
  --oltp-point-select-all-cols=[on|off]    select all columns for the point-select query [off]
  --oltp-secondary=[on|off]                Use a secondary index in place of the PRIMARY index [off]
  --oltp-num-partitions=N                  Number of partitions used for test table [0]
  --oltp-num-tables=N                      Number of test tables [1]
  --oltp-use-range=[on|off]                Use range partitions [off]
  --oltp-use-ndb-disk-data=[on|off]        Use disk storage for payload data [off]

General database options:

  --db-driver=STRING  specifies database driver to use ('help' to get list of available drivers)
  --db-ps-mode=STRING prepared statements usage mode {auto, disable} [auto]


Compiled-in database drivers:
  mysql - MySQL driver

mysql options:
  --mysql-host=[LIST,...]       MySQL server host [localhost]
  --mysql-port=N                MySQL server port [3306]
  --mysql-socket=STRING         MySQL socket
  --mysql-user=STRING           MySQL user [sbtest]
  --mysql-password=STRING       MySQL password []
  --mysql-db=STRING             MySQL database name [sbtest]
  --mysql-table-engine=STRING   storage engine to use for the test table {myisam,innodb,bdb,heap,ndbcluster,federated} [innodb]
  --mysql-engine-trx=STRING     whether storage engine used is transactional or not {yes,no,auto} [auto]
  --mysql-ssl=[on|off]          use SSL connections, if available in the client library [off]
  --myisam-max-rows=N           max-rows parameter for MyISAM tables [1000000]
  --mysql-create-options=STRING additional options passed to CREATE TABLE []

[root@ol8mysql ~]# 
```