---
layout: post
title: "MySQL 8.0 Study 009 Tips"
category: MySQL
tags: MySQL Tips
---

* content
{:toc}

MySQL 8.0 Study 009 Tips

学习系列
- MySQL Invisible Priamry Key(8.0.30)
- MySQL 双1参数说明
- Disable REDO Logging(8.0.21)
- DDL parallel
- MySQL tcpdump 抓包


### INVISIBLE 主键

INVISIBLE列 （8.0.23）
- sql_generate_invisible_primary_key

```
mysql [localhost:8032] {msandbox} (test) > create table t001(id int, col1 int);
Query OK, 0 rows affected (0.03 sec)

mysql [localhost:8032] {msandbox} (test) > show create table t001\G
*************************** 1. row ***************************
       Table: t001
Create Table: CREATE TABLE `t001` (
  `id` int DEFAULT NULL,
  `col1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)

mysql [localhost:8032] {msandbox} (test) > set session sql_generate_invisible_primary_key=on;
Query OK, 0 rows affected (0.00 sec)

mysql [localhost:8032] {msandbox} (test) > show create table t001\G
*************************** 1. row ***************************
       Table: t001
Create Table: CREATE TABLE `t001` (
  `id` int DEFAULT NULL,
  `col1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)

mysql [localhost:8032] {msandbox} (test) > create table t002(id int,col1 int);
Query OK, 0 rows affected (0.03 sec)

mysql [localhost:8032] {msandbox} (test) > show create table t002\G
*************************** 1. row ***************************
       Table: t002
Create Table: CREATE TABLE `t002` (
  `my_row_id` bigint unsigned NOT NULL AUTO_INCREMENT /*!80023 INVISIBLE */,
  `id` int DEFAULT NULL,
  `col1` int DEFAULT NULL,
  PRIMARY KEY (`my_row_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)

mysql [localhost:8032] {msandbox} (test) > 

```

### MySQL 双1参数说明

![MySQL_DoubleWrite]({{ "/files/MySQL/2023_Study/DoubleWrite.png"}})	

### Disable REDO Logging(8.0.21) 

从 8.0.21 开始提供了禁止产生redo日志的功能，在生产环境中注意使用。

目的:
- 减少 Replicas 副本写入放大
- 更快的逻辑导入，如: MySQL Shell Dump&Load时候
- 同事禁用了双写

[13.1.5 ALTER INSTANCE Statement](https://dev.mysql.com/doc/refman/8.0/en/alter-instance.html)

```
mysql [localhost:8032] {msandbox} (test) > show global status like 'innodb_redo%';
+-------------------------------------+------------+
| Variable_name                       | Value      |
+-------------------------------------+------------+
| Innodb_redo_log_read_only           | OFF        |
| Innodb_redo_log_uuid                | 1075899837 |
| Innodb_redo_log_checkpoint_lsn      | 5307998064 |
| Innodb_redo_log_current_lsn         | 5307998064 |
| Innodb_redo_log_flushed_to_disk_lsn | 5307998064 |
| Innodb_redo_log_logical_size        | 512        |
| Innodb_redo_log_physical_size       | 3276800    |
| Innodb_redo_log_capacity_resized    | 104857600  |
| Innodb_redo_log_resize_status       | OK         |
| Innodb_redo_log_enabled             | ON         |
+-------------------------------------+------------+
10 rows in set (0.00 sec)

mysql [localhost:8032] {msandbox} (test) > alter instance disable innodb redo_log;
Query OK, 0 rows affected (0.01 sec)

mysql [localhost:8032] {msandbox} (test) > show global status like 'Innodb_redo_log_enabled';
+-------------------------+-------+
| Variable_name           | Value |
+-------------------------+-------+
| Innodb_redo_log_enabled | OFF   |
+-------------------------+-------+
1 row in set (0.00 sec)

mysql [localhost:8032] {msandbox} (test) > alter instance enable innodb redo_log;
Query OK, 0 rows affected (0.03 sec)

mysql [localhost:8032] {msandbox} (test) > show global status like 'Innodb_redo_log_enabled';
+-------------------------+-------+
| Variable_name           | Value |
+-------------------------+-------+
| Innodb_redo_log_enabled | ON    |
+-------------------------+-------+
1 row in set (0.00 sec)

mysql [localhost:8032] {msandbox} (test) > 
```

[MySQL8.0特性之redo logging动态开关](https://cloud.tencent.com/developer/article/1700908)

```
在导入数据的场景下，正确的操作步骤是：
1、关闭innodb 的redo log
2、检查redo log状态，确认已经关闭
3、导数据
4、开启innodb 的redo log
5、检查redo log状态，确认已经关闭

使用该特性，有以下几点注意事项：
该特性仅用于新实例导入数据场景，尽量避免用于线上的生产环境；
Redo logging关闭状态下，支持正常流程的关闭和重启实例；但在异常宕机情况下，可能会导致丢数据和页面损坏；Redo logging关闭后异常宕机的实例需要废弃重建，直接重启会有如下报错：[ERROR] [MY-013578] [InnoDB] Server was killed when Innodb Redo logging was disabled. Data files could be corrupt. You can try to restart the database with innodb_force_recovery=6.
Redo logging关闭状态下，不支持cloning operations和redo log archiving这两个功能；
执行过程中不支持其他并发的ALTER INSTANCE操作；
```


[技术分享 MySQL 8.0.21 Disable Redo Log 性能测试](https://www.jianshu.com/p/9a60f0c16e77)

```
从实际测试情况来看，禁用与启用 redo log 有 10%~30% 的执行时间差异。
```

总结一下:

```
禁用 redo log 不影响 binlog 功能，可以正常同步。
禁用 redo log 是实例级，不支持表级。
禁用 redo log若发生 crash 是无法 recovery 的，OLTP 系统谨慎使用。
适用于大量数据导入场景。
```

### DDL parallel

[15.12.5 Configuring Parallel Threads for Online DDL Operations](https://dev.mysql.com/doc/refman/8.0/en/online-ddl-parallel-thread-configuration.html)

MySQL 8.0.14 引入了 innodb_parallel_read_threads 变量来控制扫描聚簇索引的并行线程。

MySQL 8.0.27 引入了 innodb_ddl_threads 变量来控制用于创建二级索引时的并行线程数量，此参数一般和一并引入的 innodb_ddl_buffer_size 一起使用，innodb_ddl_buffer_size 用于指定进行并行 DDL 操作时能够使用的 buffer 大小，buffer 是在所有的 DDL 并行线程中平均分配的，所以一般如果调大 innodb_ddl_threads 变量时，也需要调大 innodb_ddl_buffer_size 的大小。

- innodb_ddl_threads
- innodb_ddl_buffer_size
- innodb_parallel_read_threads 


```
mysql [localhost:8032] {msandbox} (test) > show variables like 'innodb_ddl_threads';
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| innodb_ddl_threads | 4     |
+--------------------+-------+
1 row in set (0.00 sec)

mysql [localhost:8032] {msandbox} (test) > show variables like 'innodb_ddl_buffer_size';
+------------------------+---------+
| Variable_name          | Value   |
+------------------------+---------+
| innodb_ddl_buffer_size | 1048576 |
+------------------------+---------+
1 row in set (0.00 sec)

mysql [localhost:8032] {msandbox} (test) > show variables like 'innodb_parallel_read_threads';
+------------------------------+-------+
| Variable_name                | Value |
+------------------------------+-------+
| innodb_parallel_read_threads | 4     |
+------------------------------+-------+
1 row in set (0.00 sec)

mysql [localhost:8032] {msandbox} (test) > 
```

限制:
```
The following limitations apply:

Parallel threads are not supported for building indexes that include virtual columns.

Parallel threads are not supported for full-text index creation.

Parallel threads are not supported for spatial index creation.

Parallel scan is not supported on tables defined with virtual columns.

Parallel scan is not supported on tables defined with a full-text index.

Parallel scan is not supported on tables defined with a spatial index.
```

### MySQL tcpdump 抓包

安装:
```
# dnf install tcpdump -y
```

命令如下：
```
tcpdump -s 0 -l -w - dst 192.168.56.130 and port 8032 -i en1 |strings 
其中-i指定监听的网络接口
```

参数说明：

[Tcpdump命令抓包详细分析](https://www.cnblogs.com/paul8339/p/16023548.html)

```
-i   :指定监听的网络接口
any  :这个是设置筛选的网络端口，此处举例是筛选的所有端口，如果知道详细的端口，可以替换这个内容
-A   :以ASCII格式打印出所有分组
-s 0 :取消抓包的长度限制，不加这个参数的话抓到数据的长度会被限制显示不出来
port :指定数据库端口，不知道可以不指定
-w - |strings 把包的数据，用字符展示出来，单独使用会报错，没加这个数据会显示省略号…
grep 'mh_core_data' C10  : 根据关键字显示前后10 行的数据，关键字的选择很重要，如果知道表名就根据表名筛选，这样能避免筛到很多无用的日志，也可以用select、update、delete、where、count等其他关键字，具体的关键字选择还要根据实际需求确定
抓到的数据有一些汉字显示成了…解决办法就是使用-w - |strings
```

示例:
```
tcpdump -s 65535 -x -q -tttt -i any -c 100000 port 8032 -i

tcpdump -i eth1 -s 0 -l -w - dst port 8032 | strings
```

参数说明:

```
-s 65535 或者 -s 0都表示抓取一个完整的数据包，在IP数据包中==总长度=首部+数据部分==，因此如下图所示，总长度共16~31,16bit，2^16-1=65535，即抓取整个数据包。
-x 打印每个数据包包头跟数据包内容，要想分析数据，这个参数是必须的；
-nn 不解析ip到主机名、端口号到服务名，而是直接以 ip、port的形式显示
-q 安静输出，很少打印有关协议的信息
-tttt 在每行打印前打印日期，有必要，作为时间统计
-i any 抓取所有网口的包（不包括lo），其实这里抓取 eth0就可以了
c 100000 抓取10w个数据包
port 8032 端口号
```


Server:
```
[root@ol8mysql01 ~]# tcpdump -s 65535 -x -nn -tttt -i any -c 100000 port 8032
dropped privs to tcpdump
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on any, link-type LINUX_SLL (Linux cooked v1), capture size 65535 bytes
```

Client:
```
[root@ol8mysql ~]# mysql -ulin -h192.168.56.130 -P8032 -pmysql
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 14
Server version: 8.0.32 MySQL Community Server - GPL

Copyright (c) 2000, 2022, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> select * from test.emp limit 10;
+----+-------+--------+---------+-----+------------+---------+--------+--------+
| id | empno | ename  | job     | mgr | hiredate   | sal     | comn   | deptno |
+----+-------+--------+---------+-----+------------+---------+--------+--------+
|  1 |    11 | xFzEoQ | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    107 |
|  2 |    12 | OaiMPH | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    106 |
|  3 |    13 | OsFR6N | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    103 |
|  4 |    14 | YdXZWA | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    107 |
|  5 |    15 | GviO2y | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    103 |
|  6 |    16 | DwBecb | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    109 |
|  7 |    17 | V7DEdX | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    107 |
|  8 |    18 | LMsNrE | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    106 |
|  9 |    19 | Lj8zjI | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    102 |
| 10 |    20 | SUJNEG | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    101 |
+----+-------+--------+---------+-----+------------+---------+--------+--------+
10 rows in set (0.00 sec)

mysql> 
```

抓包内容:

![MySQL_tcpdump001]({{ "/files/MySQL/2023_Study/tcpdump001.png"}})	

[基础笔记（三）网络协议之Tcp、Http](https://www.cnblogs.com/ImBit/p/5513401.html)

[从 wireshark 看 MySQL 8.0 加密连接](https://cloud.tencent.com/developer/article/1621403)

```
MySQL 8.0 的加密插件在使用中兼顾了安全与性能，建议使用默认开启，在 MySQL 8.0.16 后支持 TLSv1.3 协议。

目前网络上尝试过对 TLS 解密的手法，经笔者测试均不能在 wireshark 上解密 MySQL 8.0 的 TLS 加密消息。如果有新手法，可留言交流。

如果要进行一些 wireshark 对 MySQL 抓包的测试，需要看到 SQL query，目前建议采用 MySQL 5.7 版本或在 MySQL 8.0 上 skip-ssl 关闭加密通信。
```

### Referece

参考:


[13.1.5 ALTER INSTANCE Statement](https://dev.mysql.com/doc/refman/8.0/en/alter-instance.html)

[15.12.5 Configuring Parallel Threads for Online DDL Operations](https://dev.mysql.com/doc/refman/8.0/en/online-ddl-parallel-thread-configuration.html)


Have a good work&life! 2023/02 via LinHong


