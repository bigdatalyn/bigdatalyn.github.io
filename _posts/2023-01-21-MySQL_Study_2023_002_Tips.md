---
layout: post
title: "MySQL 8.0 Study 002 Tips"
category: MySQL
tags: MySQL Tips
---

* content
{:toc}

MySQL 8.0 Study 002 Tips

学习系列

- sysbench 1.0.20安装
- 存量直方图导入功能(MySQL 8.0.31 最新小版本)
- 数据库时间与系统时间不一致
- show engine innodb status 查看







### 01. sysbench 1.0.20安装

测试环境:
- Linux 8/64_x86
- MySQL 8.0.32 社区版

```
下载地址：https://github.com/akopytov/sysbench
# dnf install -y make automake libtool
# tar -zxvf sysbench-1.0.20.tar.gz
# cp -R sysbench-1.0.20/ /opt
# cd /opt
# ln -s sysbench-1.0.20/ sysbench
# cd sysbench
# ./autogen.sh 
# ./configure --prefix /usr/local/sysbench --with-mysql --with-mysql-includes=/opt/mysql/8.0.32/include --with-mysql-libs=/opt/mysql/8.0.32/lib
# make && make install
# ln -s /usr/local/sysbench/bin/* /usr/bin
# sysbench --version

sysbench 1.0.20
```


起一个8.0.23的mysql:

```
# dbdeployer --sandbox-binary=/opt/mysql/ deploy multiple 8.0.23 -n 2
# dbdeployer --sandbox-binary=/opt/mysql deploy single 8.0.32
# dbdeployer deploy single 8.0.32 --sandbox-binary=/opt/mysql/ --bind-address=0.0.0.0 --port=8032 --remote-access='%' --native-auth-plugin --gtid --my-cnf-options="skip_name_resolve" --pre-grants-sql="create user lin@'%' identified with mysql_native_password by 'mysql';grant all on *.* to 'lin'@'%' with grant option;flush privileges;"

mysql -ulin -pmysql -h192.168.56.130 -P8032
```

准备一张表:

```
sysbench \
/usr/local/sysbench/share/sysbench/oltp_update_index.lua \
--mysql-user=msandbox \
--mysql_password=msandbox \
--mysql-host=127.0.0.1 \
--mysql-port=8032 \
--mysql-db=test \
--tables=1 \
--table-size=1000000 \
--threads=10 \
--events=0 \
--report-interval=3 \
--db-ps-mode=disable \
prepare
```

开多一个窗口查看:

```
mysqladmin -ulin -h192.168.56.130 -P8032 -p'mysql' extended-status -i1|awk 'BEGIN{local_switch=0}
     $2 ~ /Queries$/            {q=$4-lq;lq=$4;}
     $2 ~ /com_commit$/         {c=$4-lc;lc=$4;}
     $2 ~ /Com_rollback$/       {r=$4-lr;lr=$4;}
     $2 ~ /Com_select$/       {s=$4-ls;ls=$4;}
     $2 ~ /Com_update$/       {u=$4-lu;lu=$4;}
     $2 ~ /Com_insert$/       {i=$4-li;li=$4;}
     $2 ~ /Com_delete$/       {d=$4-ld;ld=$4;}
     $2 ~ /Innodb_rows_read$/       {irr=$4-lirr;lirr=$4;}
     $2 ~ /Innodb_rows_deleted$/       {ird=$4-lird;lird=$4;}
     $2 ~ /Innodb_rows_inserted$/       {iri=$4-liri;liri=$4;}
     $2 ~ /Innodb_rows_updated$/       {iru=$4-liru;liru=$4;}
     $2 ~ /Innodb_buffer_pool_read_requests$/       {ibprr=$4-libprr;libprr=$4;}
     $2 ~ /Innodb_buffer_pool_reads$/       {ibpr=$4-libpr;libpr=$4;}
     $2 ~ /Threads_connected$/  {tc=$4;}
     $2 ~ /Threads_running$/    {tr=$4;
        if(local_switch==0)
                {local_switch=1; count=16}
        else {
                if(count>15) {
                    count=0;
                    print "----------------------------------------------------------------------------------------------------------------------------------------------- ";
                    print "-------- Time -------|  QPS | Commit Rollback TPS | select insert update delete |  read inserted updated deleted | logical physical | Tcon Trun";
                    print "----------------------------------------------------------------------------------------------------------------------------------------------- ";
                }else{
                    count+=1;
                    printf "%s | %-5d| %-6d %-7d %-5d| %-7d %-7d %-5d %-6d| %-7d %-7d %-7d %-7d| %-6d  %-9d| %-4d %-2d \n", strftime("%Y/%m/%d/ %H:%M:%S"),q,c,r,c+r,s,u,i,d,irr,ird,iri,iru,ibprr,ibpr,tc,tr;
                }
        }
}'
```

测试下性能:

```
sysbench \
/usr/local/sysbench/share/sysbench/oltp_update_index.lua \
--mysql-user=msandbox \
--mysql_password=msandbox \
--mysql-host=127.0.0.1 \
--mysql-port=8032 \
--mysql-db=test \
--tables=1 \
--table-size=1000000 \
--threads=10 \
--events=0 \
--time=15 \
--report-interval=3 \
--db-ps-mode=disable \
run
```

间隔查看 iostat

```
iostat -x 1 
```

测试结果:

QPS info:

![MySQL_2023_Test01]({{ "/files/MySQL/2023_Study/Test01.png"}})	

iostat info:

![MySQL_2023_Test02]({{ "/files/MySQL/2023_Study/Test02.png"}})	

### Referece

参考:

[Sysbench的安装(Build Install)](https://www.cnblogs.com/chengwaixue/p/15073864.html)



Have a good work&life! 2023/01 via LinHong


