---
layout: post
title: "MySQL 8.0 Study 000 Tips"
category: MySQL
tags: MySQL scripts Tips
---

* content
{:toc}

MySQL 8.0 Study 000 Tips

常用sql

- MySQL 对象容量查看sql
- Mysqladmin 查看QPS
- MySQL 创建测试表数据



### MySQL 对象容量查看sql


1.查看所有数据库各容量大小

```
select
table_schema as '数据库',
sum(table_rows) as '记录数',
sum(truncate(data_length/1024/1024, 2)) as '数据容量(MB)',
sum(truncate(index_length/1024/1024, 2)) as '索引容量(MB)'
from information_schema.tables
group by table_schema
order by sum(data_length) desc, sum(index_length) desc;
```

2.查看所有数据库各表容量大小

```
select
table_schema as '数据库',
table_name as '表名',
table_rows as '记录数',
truncate(data_length/1024/1024, 2) as '数据容量(MB)',
truncate(index_length/1024/1024, 2) as '索引容量(MB)'
from information_schema.tables
order by data_length desc, index_length desc;
```

3.查看指定数据库容量大小

例：查看mysql库容量大小
```
select
table_schema as '数据库',
sum(table_rows) as '记录数',
sum(truncate(data_length/1024/1024, 2)) as '数据容量(MB)',
sum(truncate(index_length/1024/1024, 2)) as '索引容量(MB)'
from information_schema.tables
where table_schema='mysql';
```

4.查看指定数据库各表容量大小
例：查看mysql库各表容量大小
```
select
table_schema as '数据库',
table_name as '表名',
table_rows as '记录数',
truncate(data_length/1024/1024, 2) as '数据容量(MB)',
truncate(index_length/1024/1024, 2) as '索引容量(MB)'
from information_schema.tables
where table_schema='mysql'
order by data_length desc, index_length desc;
```

### Mysqladmin 查看QPS

```
mysqladmin -ulin -h127.0.0.1 -P8032 -p'mysql' extended-status -i1 | awk '/Queries/{q=$4-qp;qp=$4} /Threads_connected/{tc=$4} /Threads_running/{printf "%5d %5d %5d\n",q,tc,$4}'

第一列：每秒查询量   
第二列：链接数
第三列：当前执行的链接数
```

```
mysqladmin -ulin -h127.0.0.1 -P8032 -p'mysql' extended-status -i1|awk 'BEGIN{local_switch=0;print "-------- Time -------| QPS   Commit Rollback   TPS    Threads_con Threads_run \n----------------------------------------------------------------------------- "}
    $2 ~ /Queries$/            {q=$4-lq;lq=$4;}
    $2 ~ /Com_commit$/         {c=$4-lc;lc=$4;}
    $2 ~ /Com_rollback$/       {r=$4-lr;lr=$4;}
    $2 ~ /Threads_connected$/  {tc=$4;}
    $2 ~ /Threads_running$/    {tr=$4;
    if(local_switch==0)
            {local_switch=1; count=0}
    else {
            if(count>10){
                    count=0;
                    print "-----------------------------------------------------------------------------";
                    print "-------- Time -------| QPS   Commit Rollback   TPS    Threads_con Threads_run";
                    print "----------------------------------------------------------------------------- ";
                    }
            else{
                    count+=1;
                    printf "%s | %-6d %-8d %-7d %-8d %-10d %d \n", strftime("%Y/%m/%d/ %H:%M:%S"),q,c,r,c+r,tc,tr;
            }
    }
}'


mysqladmin -ulin -h127.0.0.1 -P8032 -p'mysql' extended-status -i1|awk 'BEGIN{local_switch=0}
     $2 ~ /Queries$/            {q=$4-lq;lq=$4;}
     $2 ~ /com_commit$/         {c=$4-lc;lc=$4;}
     $2 ~ /Com_rollback$/       {r=$4-lr;lr=$4;}
     $2 ~ /Com_select$/       {s=$4-ls;ls=$4;}
     $2 ~ /Com_update$/       {u=$4-lu;lu=$4;}
     $2 ~ /Com_insert$/       {i=$4-li;li=$4;}
     $2 ~ /Com_delete$/       {d=$4-ld;ld=$4;}
     $2 ~ /Innodb_rows_read$/       {irr=$4-lirr;lirr=$4;}
     $2 ~ /Innodb_rows_deleted$/       {ird=$4-lird;lird=$4;}
     $2 ~ /Innodb_rows_inserted$/       {iri=$4-liri;liri=$4;}
     $2 ~ /Innodb_rows_updated$/       {iru=$4-liru;liru=$4;}
     $2 ~ /Innodb_buffer_pool_read_requests$/       {ibprr=$4-libprr;libprr=$4;}
     $2 ~ /Innodb_buffer_pool_reads$/       {ibpr=$4-libpr;libpr=$4;}
     $2 ~ /Threads_connected$/  {tc=$4;}
     $2 ~ /Threads_running$/    {tr=$4;
        if(local_switch==0)
                {local_switch=1; count=16}
        else {
                if(count>15) {
                    count=0;
                    print "----------------------------------------------------------------------------------------------------------------------------------------------- ";
                    print "-------- Time -------|  QPS | Commit Rollback TPS | select insert update delete |  read inserted updated deleted | logical physical | Tcon Trun";
                    print "----------------------------------------------------------------------------------------------------------------------------------------------- ";
                }else{
                    count+=1;
                    printf "%s | %-5d| %-6d %-7d %-5d| %-7d %-7d %-5d %-6d| %-7d %-7d %-7d %-7d| %-6d  %-9d| %-4d %-2d \n", strftime("%Y/%m/%d/ %H:%M:%S"),q,c,r,c+r,s,u,i,d,irr,ird,iri,iru,ibprr,ibpr,tc,tr;
                }
        }
}'

mysqladmin -ulin -h127.0.0.1 -P8032 -p'mysql' extended-status -i1 |\
awk -F"|" \
"BEGIN{ count=0; }"\
'{ if($2 ~ /Variable_name/ && ((++count)%20 == 1)){\
print "---------------------- - MySQL Command Status - -------------- Innodb Row Operation -------------- Buffer Pool Read--" ; \
print "--------Time----------|---Qps---|select insert  update delete|   read inserted updated deleted|   logical    physical";\
}\
else if ($2 ~ /Queries /){queries=$3;}\
else if ($2 ~ /Com_select /) {com_select=$3;}\
else if ($2 ~ /Com_insert /) {com_insert=$3;}\
else if ($2 ~ /Com_update /) {com_update=$3;}\
else if ($2 ~ /Com_delete /) {com_delete=$3;}\
else if ($2 ~ /Innodb_rows_read /) {innodb_rows_read=$3;}\
else if ($2 ~ /Innodb_rows_updated /) {innodb_rows_updated=$3;}\
else if ($2 ~ /Innodb_rows_deleted /) {innodb_rows_deleted=$3;}\
else if ($2 ~ /Innodb_rows_inserted /) {innodb_rows_inserted=$3;}\
else if ($2 ~ /Innodb_buffer_pool_read_requests /) {innodb_lor=$3;}\
else if ($2 ~ /Innodb_buffer_pool_reads /) {innodb_phr=$3;}\
else if ($2 ~ /Uptime / && count >= 2) {\
  printf(" %s |%9d",strftime ("%Y/%m/%d/ %H:%M:%S") , queries);\
  printf("|%6d %6d %6d %6d", com_select, com_insert, com_update, com_delete);\
  printf("|%6d %8d %7d %7d", innodb_rows_read, innodb_rows_inserted, innodb_rows_updated, innodb_rows_deleted );\
  printf("|%10d %11d\n", innodb_lor,innodb_phr);\
}}'
```
### MySQL 创建测试表数据

```
-- 参考: https://blog.csdn.net/a724888/article/details/79394168

-- 创建一个临时内存表
DROP TABLE IF EXISTS `vote_record_memory`;
CREATE TABLE `vote_record_memory` (
    `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
    `user_id` varchar(20) NOT NULL DEFAULT '',
    `vote_num` int(10) unsigned NOT NULL DEFAULT '0',
    `group_id` int(10) unsigned NOT NULL DEFAULT '0',
    `status` tinyint(2) unsigned NOT NULL DEFAULT '1',
    `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
    PRIMARY KEY (`id`),
    KEY `index_user_id` (`user_id`) USING HASH
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

-- 创建一个普通表，用作模拟大数据的测试用例
DROP TABLE IF EXISTS `vote_record`;

CREATE TABLE `vote_record` (
    `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
    `user_id` varchar(20) NOT NULL DEFAULT '' COMMENT '用户Id',
    `vote_num` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '投票数',
    `group_id` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '用户组id 0-未激活用户 1-普通用户 2-vip用户 3-管理员用户',
    `status` tinyint(2) unsigned NOT NULL DEFAULT '1' COMMENT '状态 1-正常 2-已删除',
    `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `index_user_id` (`user_id`) USING HASH COMMENT '用户ID哈希索引'
) ENGINE = InnoDB DEFAULT CHARSET = utf8 COMMENT = '投票记录表';

-- 为了数据的随机性和真实性，我们需要创建一个可生成长度为n的随机字符串的函数。
-- 创建生成长度为n的随机字符串的函数
DELIMITER // -- 修改MySQL delimiter：'//'
DROP FUNCTION IF EXISTS `rand_string` //
SET NAMES utf8 //
CREATE FUNCTION `rand_string` (n INT) RETURNS VARCHAR(255) CHARSET 'utf8'
BEGIN 
    DECLARE char_str varchar(100) DEFAULT 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    DECLARE return_str varchar(255) DEFAULT '';
    DECLARE i INT DEFAULT 0;
    WHILE i < n DO
        SET return_str = concat(return_str, substring(char_str, FLOOR(1 + RAND()*62), 1));
        SET i = i+1;
    END WHILE;
    RETURN return_str;
END 
//

-- ++++++++++++++++++++++++++++++++++++++++++
DROP FUNCTION IF EXISTS rand_string;
DELIMITER $$
CREATE FUNCTION rand_string(n INT)
RETURNS VARCHAR(255)
BEGIN
    DECLARE chars_str varchar(100) DEFAULT 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    DECLARE return_str varchar(255) DEFAULT '';
    DECLARE i INT DEFAULT 0;
    WHILE i < n DO
        SET return_str = concat(return_str,substring(chars_str , FLOOR(1 + RAND()*62 ),1));
        SET i = i +1;
    END WHILE;
    RETURN return_str;
END $$
DELIMITER ;
-- ++++++++++++++++++++++++++++++++++++++++++


-- 创建插入数据的存储过程
DROP PROCEDURE IF EXISTS `add_vote_record_memory` //
CREATE PROCEDURE `add_vote_record_memory`(IN n INT)
BEGIN
    DECLARE i INT DEFAULT 1;
    DECLARE vote_num INT DEFAULT 0;
    DECLARE group_id INT DEFAULT 0;
    DECLARE status TINYINT DEFAULT 1;
    WHILE i < n DO
        SET vote_num = FLOOR(1 + RAND() * 10000);
        SET group_id = FLOOR(0 + RAND()*3);
        SET status = FLOOR(1 + RAND()*2);
        INSERT INTO `vote_record_memory` VALUES (NULL, rand_string(20), vote_num, group_id, status, NOW());
        SET i = i + 1;
    END WHILE;
END //
DELIMITER ;  -- 改回默认的 MySQL delimiter：';'

-- 查询内存表已生成记录(为了下步测试，目前仅生成了105645条)
CALL add_vote_record_memory(100000);
SELECT count(*) FROM `vote_record_memory`;

-- 把数据从内存表插入到普通表中(10w条数据13s就插入完了)
INSERT INTO vote_record SELECT * FROM `vote_record_memory`;
SELECT count(*) FROM `vote_record`;

-- 参数n是每次要插入的条数
-- lastid是已导入的最大id
DELIMITER // -- 修改MySQL delimiter：'//'
DROP PROCEDURE IF EXISTS `copy_data_from_tmp` //
CREATE PROCEDURE `copy_data_from_tmp`(IN n INT)
BEGIN
    DECLARE lastid INT DEFAULT 0;
    SELECT MAX(id) INTO lastid FROM `vote_record`;
    INSERT INTO `vote_record` SELECT * FROM `vote_record_memory` where id > lastid LIMIT n;
END //
DELIMITER ;  -- 改回默认的 MySQL delimiter：';'

-- 调用存储过程 插入6w条
CALL copy_data_from_tmp(60000);
```

错误:
```
    ->     `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
ERROR 1067 (42000): Invalid default value for 'create_time'
mysql [localhost:8032] {msandbox} (test) > 
```
mysql错误总结-ERROR 1067 (42000): Invalid default value for TIMESTAMP
https://blog.csdn.net/baidu_38432732/article/details/109750336
sql_mode兼容性，MySQL 8.0 升级踩过的坑
https://cloud.tencent.com/developer/article/2005372

在MySQL 5.7 之前，DBA经常习惯使用 grant 语法来创建用户和授权。MySQL 5.7 仍然支持这种语法来创建用户，但是为了限制这种创建用户的行为，引入了NO_AUTO_CREATE_USER的sql模式。[NO_AUTO_CREATE_USER]， 即在grant语句中禁止创建空密码的账户，使用grant语法创建用户必须带上 “identified by”关键字设置账户密码，否则就被认为是非法的创建语句。

而在MySQL 8.0.11版本之后，官方认为DBA们已经接受了默认使用create user语法来创建账户的行为，就直接把grant创建账户的语法给废弃了。grant语法创建账户都不允许了，那么NO_AUTO_CREATE_USER模式也就自然要退出历史舞台了，所以就在8.0.11 中同时废弃了这个模式，以后不再支持。

新增 
```
sql_mode = ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION

MySQL 8 取消了 NO_AUTO_CREATE_USER
```

错误:
```
ERROR 1418 (HY000): This function has none of DETERMINISTIC, NO SQL, or READS SQL DATA in its declaration and binary logging is enabled (you *might* want to use the less safe log_bin_trust_function_creators variable)
```
错误分析
```
我们就必须指定我们的函数是否是
DETERMINISTIC 不确定的
NO SQL 没有SQl语句
READS SQL DATA 只是读取数据
MODIFIES SQL DATA 要修改数据
CONTAINS SQL 包含SQL语句
其中在function/procedure 里面，只有 DETERMINISTIC, NO SQL 和 READS SQL DATA 被支持。如果我们开启了 bin-log, 我们就必须为我们的function/procedure 指定一个参数。

解决方法
1.在mysql数据库中执行以下语句 （临时生效，重启后失效）
set global log_bin_trust_function_creators=TRUE;
或者

set global log_bin_trust_function_creators=1;
2. 在配置文件/etc/my.cnf的[mysqld]或者my-default.ini文件中配置
log_bin_trust_function_creators=1
```


### Ref

[查看mysql数据库容量大小](https://www.cnblogs.com/--smile/p/11451238.html)

Have a good work&life! 2023/01 via LinHong


