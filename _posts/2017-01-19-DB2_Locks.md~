---
layout: post
title: "[原创]DB2-怎么查找哪些表的哪些行被X锁了？"
categories: DB2
tags: DB2 lock db2pd
---

* content
{:toc}


DB2-怎么查找哪些表的哪些行被X锁了？





#### 设置参数：CUR_COMMIT

	[db2inst1@oc6748481478 ~]$ db2 get db cfg show detail | grep -i commit
	 All committed transactions have been written to disk    = NO
	 Currently Committed                        (CUR_COMMIT) = ON                         ON                        
	[db2inst1@oc6748481478 ~]$ 
	[db2inst1@oc6748481478 ~]$ db2 update db cfg using CUR_COMMIT DISABLED
	DB20000I  The UPDATE DATABASE CONFIGURATION command completed successfully.
	SQL1363W  One or more of the parameters submitted for immediate modification 
	were not changed dynamically. For these configuration parameters, the database 
	must be shutdown and reactivated before the configuration parameter changes 
	become effective.
	[db2inst1@oc6748481478 ~]$ db2 get db cfg show detail | grep -i commit
	 All committed transactions have been written to disk    = NO
	 Currently Committed                        (CUR_COMMIT) = ON                         DISABLED                  
	[db2inst1@oc6748481478 ~]$ db2 force applications all
	DB20000I  The FORCE APPLICATION command completed successfully.
	DB21024I  This command is asynchronous and may not be effective immediately.

	[db2inst1@oc6748481478 ~]$ db2stop
	SQL1064N  DB2STOP processing was successful.
	[db2inst1@oc6748481478 ~]$ db2start
	SQL1063N  DB2START processing was successful.
	[db2inst1@oc6748481478 ~]$ db2 connect to sample

	   Database Connection Information

	 Database server        = DB2/LINUXX8664 10.5.5
	 SQL authorization ID   = DB2INST1
	 Local database alias   = SAMPLE

	[db2inst1@oc6748481478 ~]$ db2 get db cfg show detail | grep -i commit
	 All committed transactions have been written to disk    = YES
	 Currently Committed                        (CUR_COMMIT) = DISABLED                   DISABLED                  
	[db2inst1@oc6748481478 ~]$ 


#### 测试

第一窗口 创建表并插入数据

	[db2inst1@oc6748481478 ~]$ db2 "create table t2(col1 char(10),col2 varchar(10))"
	DB20000I  The SQL command completed successfully.
	[db2inst1@oc6748481478 ~]$ db2 "insert into t2 values('aaa','bbb')"
	DB20000I  The SQL command completed successfully.
	[db2inst1@oc6748481478 ~]$ db2 "insert into t2 values('aaa','bbb')"
	DB20000I  The SQL command completed successfully.
	[db2inst1@oc6748481478 ~]$ db2 +c "insert into t2 values('ccc','ddd') with rs"
	DB20000I  The SQL command completed successfully.
	[db2inst1@oc6748481478 ~]$ 


第二窗口 查看表和行锁信息

	[db2inst1@oc6748481478 ~]$ db2 connect to sample

	   Database Connection Information

	 Database server        = DB2/LINUXX8664 10.5.5
	 SQL authorization ID   = DB2INST1
	 Local database alias   = SAMPLE

	[db2inst1@oc6748481478 ~]$ db2pd -d sample -locks

	Database Member 0 -- Database SAMPLE -- Active -- Up 0 days 00:03:10 -- Date 2017-01-20-10.51.06.084667

	Locks:
	Address            TranHdl    Lockname                   Type           Mode Sts Owner      Dur HoldCount  Att        ReleaseFlg rrIID 
	0x00007F9F274D2400 3          4141414141664164FE8BC714C1 PlanLock       ..S  G   3          1   0          0x00000000 0x40000000 0     
	0x00007F9F274D5800 3          04000B00060000000000000052 RowLock        ..X  G   3          1   0          0x00200008 0x40000000 0     
	0x00007F9F274D6280 3          04000B00000000000000000054 TableLock      .IX  G   3          1   0          0x00202000 0x40000000 0     
	[db2inst1@oc6748481478 ~]$ db2pd -d sample -locks show details
	Invalid suboption details
	Invalid suboption details

	Database Member 0 -- Database SAMPLE -- Active -- Up 0 days 00:03:26 -- Date 2017-01-20-10.51.22.327193

	Locks:
	Address            TranHdl    Lockname                   Type           Mode Sts Owner      Dur HoldCount  Att        ReleaseFlg rrIID TableNm            SchemaNm 
	0x00007F9F274D2400 3          4141414141664164FE8BC714C1 PlanLock       ..S  G   3          1   0          0x00000000 0x40000000 0     N/A                N/A      	4141414141664164FE8BC714C1 SQLP_PLAN ({41414141 64416641 14C78BFE}, loading=0)
	0x00007F9F274D5800 3          04000B00060000000000000052 RowLock        ..X  G   3          1   0          0x00200008 0x40000000 0     T2                 DB2INST1 	04000B00060000000000000052 SQLP_RECORD (obj={4;11}, rid=d(0;0;6), x0600000000000000)
	0x00007F9F274D6280 3          04000B00000000000000000054 TableLock      .IX  G   3          1   0          0x00202000 0x40000000 0     T2                 DB2INST1 	04000B00000000000000000054 SQLP_TABLE (obj={4;11})
	[db2inst1@oc6748481478 ~]$ 


#### 查看是那张表和那一行的X锁记录：

针对这行锁信息，

	0x00007F9F274D5800 3          04000B00060000000000000052 RowLock        ..X  G   3          1   0          0x00200008 0x40000000 0     T2                 DB2INST1 	04000B00060000000000000052 SQLP_RECORD (obj={4;11}, rid=d(0;0;6), x0600000000000000)

计算和分析得到

04000B00060000000000000052和(obj={4;11}, rid=d(0;0;6), x0600000000000000) 提示了是那个表空间，那个分区，那page的那个slot上

通过视图和rid定位那行信息

	[db2inst1@oc6748481478 ~]$ db2 "select TABSCHEMA,TABNAME,TABLEID,TBSPACE,TBSPACEID from syscat.tables where TBSPACEID=4 and TABLEID=11" | tr -s " " 

	TABSCHEMA TABNAME TABLEID TBSPACE TBSPACEID
	-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------- -------------------------------------------------------------------------------------------------------------------------------- ---------
	DB2INST1 T2 11 IBMDB2SAMPLEREL 4

	 1 record(s) selected.

	[db2inst1@oc6748481478 ~]$ 
	[db2inst1@oc6748481478 ~]$ db2 "select t.*,rid(t) as rid from db2inst1.t2 t";

	COL1       COL2       RID                 
	---------- ---------- --------------------
	aaa        bbb                           4
	aaa        bbb                           5
	ccc        ddd                           6

	  3 record(s) selected.

	[db2inst1@oc6748481478 ~]$ 


#### 关于DB2锁的一些测试

[关于DB2锁的一些测试]({{ "/files/DB2/Locks/Lock&Concurrency_example.xls"}}) 



----------- EOF ----------- 
