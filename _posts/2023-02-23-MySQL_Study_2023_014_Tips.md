---
layout: post
title: "MySQL 8.0 Study 014 Tips"
category: MySQL
tags: MySQL Tips
---

* content
{:toc}

MySQL 8.0 Study 014 Tips

学习系列
- MySQL employees-schema 导入测试
- MySQL ICP(Index Condition Pushdown) 测试










### MySQL employees-schema 导入测试

MySQL官方文档中关于此`employees-schema`数据库参考如下

[employees-installation](https://dev.mysql.com/doc/employee/en/employees-installation.html)

[github test_db](https://github.com/datacharmer/test_db)


MySQL employees-schema 导入和确实

ER 结构图如下:

![MySQL_MySQL_employees-schema]({{ "/files/MySQL/2023_Study/employees-schema.png"}})	

```
[root@ol8mysql01 vagrant]# unzip test_db-master.zip 
Archive:  test_db-master.zip
d01cb62fcfa4671773f167480df174d8ce4316c1
   creating: test_db-master/
  inflating: test_db-master/Changelog  
  inflating: test_db-master/README.md  
  inflating: test_db-master/employees.sql  
  inflating: test_db-master/employees_partitioned.sql  
  inflating: test_db-master/employees_partitioned_5.1.sql  
   creating: test_db-master/images/
  inflating: test_db-master/images/employees.gif  
  inflating: test_db-master/images/employees.jpg  
  inflating: test_db-master/images/employees.png  
  inflating: test_db-master/load_departments.dump  
  inflating: test_db-master/load_dept_emp.dump  
  inflating: test_db-master/load_dept_manager.dump  
  inflating: test_db-master/load_employees.dump  
  inflating: test_db-master/load_salaries1.dump  
  inflating: test_db-master/load_salaries2.dump  
  inflating: test_db-master/load_salaries3.dump  
  inflating: test_db-master/load_titles.dump  
  inflating: test_db-master/objects.sql  
   creating: test_db-master/sakila/
  inflating: test_db-master/sakila/README.md  
  inflating: test_db-master/sakila/sakila-mv-data.sql  
  inflating: test_db-master/sakila/sakila-mv-schema.sql  
  inflating: test_db-master/show_elapsed.sql  
  inflating: test_db-master/sql_test.sh  
  inflating: test_db-master/test_employees_md5.sql  
  inflating: test_db-master/test_employees_sha.sql  
  inflating: test_db-master/test_versions.sh  
[root@ol8mysql01 vagrant]#cd test_db-master
[root@ol8mysql01 test_db-master]# pwd
/vagrant/test_db-master
[root@ol8mysql01 test_db-master]# # mysql -S /tmp/mysql_sandbox8033.sock < employees.sqlINFO
CREATING DATABASE STRUCTURE
INFO
storage engine: InnoDB
INFO
LOADING departments
INFO
LOADING employees
INFO
LOADING dept_emp
INFO
LOADING dept_manager
INFO
LOADING titles
INFO
LOADING salaries
data_load_time_diff
00:00:45
[root@ol8mysql01 test_db-master]# 
[root@ol8mysql01 test_db-master]# time mysql -S /tmp/mysql_sandbox8033.sock -t < test_employees_sha.sql
+----------------------+
| INFO                 |
+----------------------+
| TESTING INSTALLATION |
+----------------------+
+--------------+------------------+------------------------------------------+
| table_name   | expected_records | expected_crc                             |
+--------------+------------------+------------------------------------------+
| departments  |                9 | 4b315afa0e35ca6649df897b958345bcb3d2b764 |
| dept_emp     |           331603 | d95ab9fe07df0865f592574b3b33b9c741d9fd1b |
| dept_manager |               24 | 9687a7d6f93ca8847388a42a6d8d93982a841c6c |
| employees    |           300024 | 4d4aa689914d8fd41db7e45c2168e7dcb9697359 |
| salaries     |          2844047 | b5a1785c27d75e33a4173aaa22ccf41ebd7d4a9f |
| titles       |           443308 | d12d5f746b88f07e69b9e36675b6067abb01b60e |
+--------------+------------------+------------------------------------------+

+--------------+------------------+------------------------------------------+
| table_name   | found_records    | found_crc                                |
+--------------+------------------+------------------------------------------+
| departments  |                9 | 4b315afa0e35ca6649df897b958345bcb3d2b764 |
| dept_emp     |           331603 | d95ab9fe07df0865f592574b3b33b9c741d9fd1b |
| dept_manager |               24 | 9687a7d6f93ca8847388a42a6d8d93982a841c6c |
| employees    |           300024 | 4d4aa689914d8fd41db7e45c2168e7dcb9697359 |
| salaries     |          2844047 | b5a1785c27d75e33a4173aaa22ccf41ebd7d4a9f |
| titles       |           443308 | d12d5f746b88f07e69b9e36675b6067abb01b60e |
+--------------+------------------+------------------------------------------+
+--------------+---------------+-----------+
| table_name   | records_match | crc_match |
+--------------+---------------+-----------+
| departments  | OK            | ok        |
| dept_emp     | OK            | ok        |
| dept_manager | OK            | ok        |
| employees    | OK            | ok        |
| salaries     | OK            | ok        |
| titles       | OK            | ok        |
+--------------+---------------+-----------+
+------------------+
| computation_time |
+------------------+
| 00:00:47         |
+------------------+
+---------+--------+
| summary | result |
+---------+--------+
| CRC     | OK     |
| count   | OK     |
+---------+--------+

real	0m46.895s
user	0m0.017s
sys	0m0.000s
[root@ol8mysql01 test_db-master]# 
```


### MySQL ICP(Index Condition Pushdown) 测试

Index Condition Pushdown (ICP)是MySQL 5.6 版本中的新特性,是一种在存储引擎层使用索引过滤数据的一种优化方式。

- 当关闭ICP时,index 仅仅是data access 的一种访问方式，存储引擎通过索引回表获取的数据会传递到MySQL Server 层进行where条件过滤。
- 当打开ICP时,如果部分where条件能使用索引中的字段,MySQL Server 会把这部分下推到引擎层,可以利用index过滤的where条件在存储引擎层进行数据过滤,而非将所有通过index access的结果传递到MySQL server层进行where过滤.

优化效果:ICP能减少引擎层访问基表的次数和MySQL Server 访问存储引擎的次数,减少io次数，提高查询语句性能。

关闭索引下推可以使用如下命令

```
set optimizer_switch='index_condition_pushdown=off';
```


#### 测试


创建employees first_name/last_name的组合索引

```
mysql [localhost:8032] {msandbox} ((none)) > use employees;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql [localhost:8032] {msandbox} (employees) > show tables;
+----------------------+
| Tables_in_employees  |
+----------------------+
| current_dept_emp     |
| departments          |
| dept_emp             |
| dept_emp_latest_date |
| dept_manager         |
| employees            |
| salaries             |
| titles               |
+----------------------+
8 rows in set (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > show index from employees;
+-----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table     | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+-----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| employees |          0 | PRIMARY  |            1 | emp_no      | A         |      299246 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
+-----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
1 row in set (0.01 sec)

mysql [localhost:8032] {msandbox} (employees) > desc employees;
+------------+---------------+------+-----+---------+-------+
| Field      | Type          | Null | Key | Default | Extra |
+------------+---------------+------+-----+---------+-------+
| emp_no     | int           | NO   | PRI | NULL    |       |
| birth_date | date          | NO   |     | NULL    |       |
| first_name | varchar(14)   | NO   |     | NULL    |       |
| last_name  | varchar(16)   | NO   |     | NULL    |       |
| gender     | enum('M','F') | NO   |     | NULL    |       |
| hire_date  | date          | NO   |     | NULL    |       |
+------------+---------------+------+-----+---------+-------+
6 rows in set (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > create index idx_emp_first_lastname on employees(first_name,last_name);
Query OK, 0 rows affected (2.35 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql [localhost:8032] {msandbox} (employees) > show index from employees;
+-----------+------------+------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table     | Non_unique | Key_name               | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+-----------+------------+------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| employees |          0 | PRIMARY                |            1 | emp_no      | A         |      299246 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
| employees |          1 | idx_emp_first_lastname |            1 | first_name  | A         |        1311 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
| employees |          1 | idx_emp_first_lastname |            2 | last_name   | A         |      276828 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
+-----------+------------+------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
3 rows in set (0.01 sec)

mysql [localhost:8032] {msandbox} (employees) > 

mysql [localhost:8032] {msandbox} (employees) > select * from employees limit 10000,2;
+--------+------------+------------+-----------+--------+------------+
| emp_no | birth_date | first_name | last_name | gender | hire_date  |
+--------+------------+------------+-----------+--------+------------+
|  20001 | 1962-05-16 | Atreye     | Eppinger  | M      | 1990-04-18 |
|  20002 | 1955-12-25 | Jaber      | Brender   | M      | 1988-01-26 |
+--------+------------+------------+-----------+--------+------------+
2 rows in set (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > 
```

测试
- 查询语句: MySQL的最左前缀原则, first_name 可以使用索引，last_name采用了like 模糊查询，不能使用索引。 

```
[root@ol8mysql01 msb_8_0_32]# ./use
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 11
Server version: 8.0.32 MySQL Community Server - GPL

Copyright (c) 2000, 2023, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql [localhost:8032] {msandbox} ((none)) > use employees;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql [localhost:8032] {msandbox} (employees) > set profiling=1;
Query OK, 0 rows affected, 1 warning (0.01 sec)

mysql [localhost:8032] {msandbox} (employees) > select * from employees where first_name='Jaber' and last_name like '%der';
+--------+------------+------------+-----------+--------+------------+
| emp_no | birth_date | first_name | last_name | gender | hire_date  |
+--------+------------+------------+-----------+--------+------------+
|  20002 | 1955-12-25 | Jaber      | Brender   | M      | 1988-01-26 |
|  17961 | 1963-07-09 | Jaber      | Schieder  | M      | 1985-12-18 |
+--------+------------+------------+-----------+--------+------------+
2 rows in set (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > select * from employees where first_name='Jaber' and last_name like '%der';
+--------+------------+------------+-----------+--------+------------+
| emp_no | birth_date | first_name | last_name | gender | hire_date  |
+--------+------------+------------+-----------+--------+------------+
|  20002 | 1955-12-25 | Jaber      | Brender   | M      | 1988-01-26 |
|  17961 | 1963-07-09 | Jaber      | Schieder  | M      | 1985-12-18 |
+--------+------------+------------+-----------+--------+------------+
2 rows in set (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > select * from employees where first_name='Jaber' and last_name like '%der';
+--------+------------+------------+-----------+--------+------------+
| emp_no | birth_date | first_name | last_name | gender | hire_date  |
+--------+------------+------------+-----------+--------+------------+
|  20002 | 1955-12-25 | Jaber      | Brender   | M      | 1988-01-26 |
|  17961 | 1963-07-09 | Jaber      | Schieder  | M      | 1985-12-18 |
+--------+------------+------------+-----------+--------+------------+
2 rows in set (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > show profiles;
+----------+------------+----------------------------------------------------------------------------+
| Query_ID | Duration   | Query                                                                      |
+----------+------------+----------------------------------------------------------------------------+
|        1 | 0.00084375 | select * from employees where first_name='Jaber' and last_name like '%der' |
|        2 | 0.00070300 | select * from employees where first_name='Jaber' and last_name like '%der' |
|        3 | 0.00097475 | select * from employees where first_name='Jaber' and last_name like '%der' |
+----------+------------+----------------------------------------------------------------------------+
3 rows in set, 1 warning (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > explain select * from employees where first_name='Jaber' and last_name like '%der';
+----+-------------+-----------+------------+------+------------------------+------------------------+---------+-------+------+----------+-----------------------+
| id | select_type | table     | partitions | type | possible_keys          | key                    | key_len | ref   | rows | filtered | Extra                 |
+----+-------------+-----------+------------+------+------------------------+------------------------+---------+-------+------+----------+-----------------------+
|  1 | SIMPLE      | employees | NULL       | ref  | idx_emp_first_lastname | idx_emp_first_lastname | 58      | const |  264 |    11.11 | Using index condition |
+----+-------------+-----------+------------+------+------------------------+------------------------+---------+-------+------+----------+-----------------------+
1 row in set, 1 warning (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > set optimizer_switch='index_condition_pushdown=off';
Query OK, 0 rows affected (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > select * from employees where first_name='Jaber' and last_name like '%der';
+--------+------------+------------+-----------+--------+------------+
| emp_no | birth_date | first_name | last_name | gender | hire_date  |
+--------+------------+------------+-----------+--------+------------+
|  20002 | 1955-12-25 | Jaber      | Brender   | M      | 1988-01-26 |
|  17961 | 1963-07-09 | Jaber      | Schieder  | M      | 1985-12-18 |
+--------+------------+------------+-----------+--------+------------+
2 rows in set (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > select * from employees where first_name='Jaber' and last_name like '%der';
+--------+------------+------------+-----------+--------+------------+
| emp_no | birth_date | first_name | last_name | gender | hire_date  |
+--------+------------+------------+-----------+--------+------------+
|  20002 | 1955-12-25 | Jaber      | Brender   | M      | 1988-01-26 |
|  17961 | 1963-07-09 | Jaber      | Schieder  | M      | 1985-12-18 |
+--------+------------+------------+-----------+--------+------------+
2 rows in set (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > select * from employees where first_name='Jaber' and last_name like '%der';
+--------+------------+------------+-----------+--------+------------+
| emp_no | birth_date | first_name | last_name | gender | hire_date  |
+--------+------------+------------+-----------+--------+------------+
|  20002 | 1955-12-25 | Jaber      | Brender   | M      | 1988-01-26 |
|  17961 | 1963-07-09 | Jaber      | Schieder  | M      | 1985-12-18 |
+--------+------------+------------+-----------+--------+------------+
2 rows in set (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > show profiles;
+----------+------------+------------------------------------------------------------------------------------+
| Query_ID | Duration   | Query                                                                              |
+----------+------------+------------------------------------------------------------------------------------+
|        1 | 0.00084375 | select * from employees where first_name='Jaber' and last_name like '%der'         |
|        2 | 0.00070300 | select * from employees where first_name='Jaber' and last_name like '%der'         |
|        3 | 0.00097475 | select * from employees where first_name='Jaber' and last_name like '%der'         |
|        4 | 0.00111750 | explain select * from employees where first_name='Jaber' and last_name like '%der' |
|        5 | 0.00021700 | set optimizer_switch='index_condition_pushdown=off'                                |
|        6 | 0.00297800 | select * from employees where first_name='Jaber' and last_name like '%der'         |
|        7 | 0.00226100 | select * from employees where first_name='Jaber' and last_name like '%der'         |
|        8 | 0.00251200 | select * from employees where first_name='Jaber' and last_name like '%der'         |
+----------+------------+------------------------------------------------------------------------------------+
8 rows in set, 1 warning (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > explain select * from employees where first_name='Jaber' and last_name like '%der';
+----+-------------+-----------+------------+------+------------------------+------------------------+---------+-------+------+----------+-------------+
| id | select_type | table     | partitions | type | possible_keys          | key                    | key_len | ref   | rows | filtered | Extra       |
+----+-------------+-----------+------------+------+------------------------+------------------------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | employees | NULL       | ref  | idx_emp_first_lastname | idx_emp_first_lastname | 58      | const |  264 |    11.11 | Using where |
+----+-------------+-----------+------------+------+------------------------+------------------------+---------+-------+------+----------+-------------+
1 row in set, 1 warning (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > set profiling=0;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql [localhost:8032] {msandbox} (employees) > 
```

- ICP 开启时的执行计划 含有 Using index condition 标示 ，表示优化器使用了ICP对数据访问进行优化。
    - last_name 的like '%der'条件可以通过索引字段last_name 进行过滤，在存储引擎内部通过与where条件的对比，直接过滤掉不符合条件的数据。
    - 该过程不回表,只访问符合条件的1条记录并返回给MySQL Server ,有效的减少了io访问和各层之间的交互。

- ICP 关闭时的执行计划显示use where.

#### ICP的使用限制 

1. 当sql需要全表访问时,ICP的优化策略可用于range, ref, eq_ref,  ref_or_null 类型的访问数据方法 。
2. 支持InnoDB和MyISAM表。
3. ICP只能用于二级索引，不能用于主索引。
4. 并非全部where条件都可以用ICP筛选。如果where条件的字段不在索引列中,还是要读取整表的记录到server端做where过滤。
5. ICP的加速效果取决于在存储引擎内通过ICP筛选掉的数据的比例。
6. 5.6 版本的不支持分表的ICP 功能，5.7 版本的开始支持。
7. 当sql 使用覆盖索引时，不支持ICP 优化方法。

### Referece

参考:

[employees-installation](https://dev.mysql.com/doc/employee/en/employees-installation.html)

[github test_db](https://github.com/datacharmer/test_db)


Have a good work&life! 2023/02 via LinHong


