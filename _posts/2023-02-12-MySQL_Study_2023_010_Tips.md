---
layout: post
title: "MySQL 8.0 Study 009 Tips"
category: MySQL
tags: MySQL Tips
---

* content
{:toc}

MySQL 8.0 Study 009 Tips

学习系列
- pt-osc(pt-online-schema-change)
- 








### pt-osc(pt-online-schema-change)

#### pt-osc的工作原理

pt-osc的工作原理
```
1. 创建一个和源表一样表结构的新表
2. 在新表执行DDL语句
3. 在源表创建三个触发器分别对应insert、update、delete操作
4. 从源表拷贝数据到新表，拷贝过程中源表通过触发器把新的DML操作更新到新表中
5. rename源表到old表中，把新表rename为源表，默认最后删除源表
```

#### pt-osc工具的限制

pt-osc工具的限制
```
1. 源表不能有触发器存在（insert、update、delete）
2. 源表必须要有主键或唯一索引，如果没有工具将停止工作
3. 源表有外键，必须使用–alter-foreign-keys-method指定特定的值
4. 如果线上的复制环境过滤器操作过于复杂，工具将无法工作
5. 如果开启复制延迟检查，但主从延迟时，工具将暂停数据拷贝工作
6. 如果开启主服务器负载检查，但主服务器负载较高时，工具将暂停操作
7. 只支持Innodb存储引擎表，且要求服务器上有该表1倍以上的空闲空间。
8. 修改索引、外键、列名时，优先采用online ddl，并指定 ALGORITHM=INPLACE
```

下载地址：
```
https://www.percona.com/downloads/percona-toolkit/LATEST/
```

#### 参数说明

![MySQL_pt-osc]({{ "/files/MySQL/2023_Study/pt-osc.png"}})	

示例:

```
pt-online-schema-change \
--host="192.168.56.130" \
--port=8032  \
--user="lin" \ 
--password="mysql" \
--charset="utf8mb4" \
--max-lag=10 \
--recursion-method="hosts" \
--check-interval=2 \
D="test",t="emp" \
--alter="add column newcolumn int(10) default 0" \
--dry-run \
--print \
--execute

--check-slave-log="192.168.56.110" \


pt-online-schema-change --user=lin --password=mysql --host=localhost --port=8032 --alter "add column age int(4) default 0" D=test,t=emp --print --dry-run
```

```

mysql> show create table emp\G
*************************** 1. row ***************************
       Table: emp
Create Table: CREATE TABLE `emp` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `empno` mediumint unsigned NOT NULL DEFAULT '0',
  `ename` varchar(20) NOT NULL DEFAULT '',
  `job` varchar(9) NOT NULL DEFAULT '',
  `mgr` mediumint unsigned NOT NULL DEFAULT '0',
  `hiredate` date NOT NULL,
  `sal` decimal(7,2) NOT NULL,
  `comn` decimal(7,2) NOT NULL,
  `deptno` mediumint unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  KEY `idx_emp_empno` (`empno`)
) ENGINE=InnoDB AUTO_INCREMENT=1001 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.01 sec)

mysql> select * from emp limit 10;
+----+-------+--------+---------+-----+------------+---------+--------+--------+
| id | empno | ename  | job     | mgr | hiredate   | sal     | comn   | deptno |
+----+-------+--------+---------+-----+------------+---------+--------+--------+
|  1 |    11 | xFzEoQ | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    107 |
|  2 |    12 | OaiMPH | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    106 |
|  3 |    13 | OsFR6N | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    103 |
|  4 |    14 | YdXZWA | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    107 |
|  5 |    15 | GviO2y | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    103 |
|  6 |    16 | DwBecb | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    109 |
|  7 |    17 | V7DEdX | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    107 |
|  8 |    18 | LMsNrE | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    106 |
|  9 |    19 | Lj8zjI | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    102 |
| 10 |    20 | SUJNEG | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    101 |
+----+-------+--------+---------+-----+------------+---------+--------+--------+
10 rows in set (0.00 sec)

mysql>

[root@ol8mysql01 ~]# pt-online-schema-change --user=lin --password=mysql --host=localhost --port=8032 --alter "add column age int(4) default 0" D=test,t=emp --print --dry-run
Operation, tries, wait:
  analyze_table, 10, 1
  copy_rows, 10, 0.25
  create_triggers, 10, 1
  drop_triggers, 10, 1
  swap_tables, 10, 1
  update_foreign_keys, 10, 1
Starting a dry run.  `test`.`emp` will not be altered.  Specify --execute instead of --dry-run to alter the table.
Creating new table...
CREATE TABLE `test`.`_emp_new` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `empno` mediumint unsigned NOT NULL DEFAULT '0',
  `ename` varchar(20) NOT NULL DEFAULT '',
  `job` varchar(9) NOT NULL DEFAULT '',
  `mgr` mediumint unsigned NOT NULL DEFAULT '0',
  `hiredate` date NOT NULL,
  `sal` decimal(7,2) NOT NULL,
  `comn` decimal(7,2) NOT NULL,
  `deptno` mediumint unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  KEY `idx_emp_empno` (`empno`)
) ENGINE=InnoDB AUTO_INCREMENT=1001 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
Created new table test._emp_new OK.
Altering new table...
ALTER TABLE `test`.`_emp_new` add column age int(4) default 0
Altered `test`.`_emp_new` OK.
Not creating triggers because this is a dry run.
-----------------------------------------------------------
Skipped trigger creation: 
Event : DELETE 
Name  : pt_osc_test_emp_del 
SQL   : CREATE TRIGGER `pt_osc_test_emp_del` AFTER DELETE ON `test`.`emp` FOR EACH ROW BEGIN DECLARE CONTINUE HANDLER FOR 1146 begin end; DELETE IGNORE FROM `test`.`_emp_new` WHERE `test`.`_emp_new`.`id` <=> OLD.`id`; END  
Suffix: del 
Time  : AFTER 
-----------------------------------------------------------
-----------------------------------------------------------
Skipped trigger creation: 
Event : UPDATE 
Name  : pt_osc_test_emp_upd 
SQL   : CREATE TRIGGER `pt_osc_test_emp_upd` AFTER UPDATE ON `test`.`emp` FOR EACH ROW BEGIN DECLARE CONTINUE HANDLER FOR 1146 begin end; DELETE IGNORE FROM `test`.`_emp_new` WHERE !(OLD.`id` <=> NEW.`id`) AND `test`.`_emp_new`.`id` <=> OLD.`id`; REPLACE INTO `test`.`_emp_new` (`id`, `empno`, `ename`, `job`, `mgr`, `hiredate`, `sal`, `comn`, `deptno`) VALUES (NEW.`id`, NEW.`empno`, NEW.`ename`, NEW.`job`, NEW.`mgr`, NEW.`hiredate`, NEW.`sal`, NEW.`comn`, NEW.`deptno`); END  
Suffix: upd 
Time  : AFTER 
-----------------------------------------------------------
-----------------------------------------------------------
Skipped trigger creation: 
Event : INSERT 
Name  : pt_osc_test_emp_ins 
SQL   : CREATE TRIGGER `pt_osc_test_emp_ins` AFTER INSERT ON `test`.`emp` FOR EACH ROW BEGIN DECLARE CONTINUE HANDLER FOR 1146 begin end; REPLACE INTO `test`.`_emp_new` (`id`, `empno`, `ename`, `job`, `mgr`, `hiredate`, `sal`, `comn`, `deptno`) VALUES (NEW.`id`, NEW.`empno`, NEW.`ename`, NEW.`job`, NEW.`mgr`, NEW.`hiredate`, NEW.`sal`, NEW.`comn`, NEW.`deptno`);END  
Suffix: ins 
Time  : AFTER 
-----------------------------------------------------------
Not copying rows because this is a dry run.
INSERT LOW_PRIORITY IGNORE INTO `test`.`_emp_new` (`id`, `empno`, `ename`, `job`, `mgr`, `hiredate`, `sal`, `comn`, `deptno`) SELECT `id`, `empno`, `ename`, `job`, `mgr`, `hiredate`, `sal`, `comn`, `deptno` FROM `test`.`emp` LOCK IN SHARE MODE /*pt-online-schema-change 24422 copy table*/
Not swapping tables because this is a dry run.
Not dropping old table because this is a dry run.
Not dropping triggers because this is a dry run.
DROP TRIGGER IF EXISTS `test`.`pt_osc_test_emp_del`
DROP TRIGGER IF EXISTS `test`.`pt_osc_test_emp_upd`
DROP TRIGGER IF EXISTS `test`.`pt_osc_test_emp_ins`
2023-02-12T23:56:25 Dropping new table...
DROP TABLE IF EXISTS `test`.`_emp_new`;
2023-02-12T23:56:25 Dropped new table OK.
Dry run complete.  `test`.`emp` was not altered.
[root@ol8mysql01 ~]# 

--execute 之后

mysql> show create table emp\G
*************************** 1. row ***************************
       Table: emp
Create Table: CREATE TABLE `emp` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `empno` mediumint unsigned NOT NULL DEFAULT '0',
  `ename` varchar(20) NOT NULL DEFAULT '',
  `job` varchar(9) NOT NULL DEFAULT '',
  `mgr` mediumint unsigned NOT NULL DEFAULT '0',
  `hiredate` date NOT NULL,
  `sal` decimal(7,2) NOT NULL,
  `comn` decimal(7,2) NOT NULL,
  `deptno` mediumint unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  KEY `idx_emp_empno` (`empno`)
) ENGINE=InnoDB AUTO_INCREMENT=1001 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)

mysql> show create table emp\G
*************************** 1. row ***************************
       Table: emp
Create Table: CREATE TABLE `emp` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `empno` mediumint unsigned NOT NULL DEFAULT '0',
  `ename` varchar(20) NOT NULL DEFAULT '',
  `job` varchar(9) NOT NULL DEFAULT '',
  `mgr` mediumint unsigned NOT NULL DEFAULT '0',
  `hiredate` date NOT NULL,
  `sal` decimal(7,2) NOT NULL,
  `comn` decimal(7,2) NOT NULL,
  `deptno` mediumint unsigned NOT NULL DEFAULT '0',
  `age` int DEFAULT '0', ######################------------------》 新增列
  PRIMARY KEY (`id`),
  KEY `idx_emp_empno` (`empno`)
) ENGINE=InnoDB AUTO_INCREMENT=1001 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.01 sec)

mysql> select * from emp limit 10;
+----+-------+--------+---------+-----+------------+---------+--------+--------+------+
| id | empno | ename  | job     | mgr | hiredate   | sal     | comn   | deptno | age  |
+----+-------+--------+---------+-----+------------+---------+--------+--------+------+
|  1 |    11 | xFzEoQ | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    107 |    0 |
|  2 |    12 | OaiMPH | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    106 |    0 |
|  3 |    13 | OsFR6N | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    103 |    0 |
|  4 |    14 | YdXZWA | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    107 |    0 |
|  5 |    15 | GviO2y | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    103 |    0 |
|  6 |    16 | DwBecb | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    109 |    0 |
|  7 |    17 | V7DEdX | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    107 |    0 |
|  8 |    18 | LMsNrE | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    106 |    0 |
|  9 |    19 | Lj8zjI | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    102 |    0 |
| 10 |    20 | SUJNEG | SALEMAN |   1 | 2023-01-29 | 2000.00 | 400.00 |    101 |    0 |
+----+-------+--------+---------+-----+------------+---------+--------+--------+------+
10 rows in set (0.01 sec)

mysql> 
```

可以详细研究下这个触发器的写法


### Linux性能调优指南

[Linux性能调优指南](https://lihz1990.gitbooks.io/transoflptg/content/)

[1分钟内的Linux性能分析法](https://zhuanlan.zhihu.com/p/350304922)

[iipeace/guider](https://github.com/iipeace/guider)

Guider是一个免费且开源的，功能强大的全系统性能分析工具，主要以Python for Linux 操作系统编写。

它旨在衡量系统资源使用量并跟踪系统行为，从而使其可以有效分析系统性能问题或进行性能调整。

它显示了大量有关 CPU，内存，每个线程的磁盘使用率，进程，系统功能（用户/内核）的信息。 因此可以非常简单地了解导致系统性能异常或改善整体系统性能的问题。


### Referece

参考:

[MySQL在线DDL工具pt-osc](https://www.jianshu.com/p/c739d12afbef)

[pt-osc原理、限制、及与原生online-ddl比较](https://www.cnblogs.com/DataArt/p/10094105.html)

Have a good work&life! 2023/02 via LinHong


